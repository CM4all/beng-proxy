\documentclass[a4paper,12pt]{article}

\begin{document}
\title{CM4all Beng}
\author{Max Kellermann}

\maketitle

\begin{abstract}
Beng proxy is an HTTP server including an HTTP proxy and a
minimalistic template processor.  Its goal is to dynamically aggregate
a web site from a number of sources (widgets).
\end{abstract}


\section{Features}

Beng-proxy delivers resources via HTTP.  In the most simple form, it
it provides a resource in pass-through mode, acting as an HTTP proxy.

It caches resources if possible.

XML resources can be transformed with XSLT.

On HTML resources, it can apply a simple template language.  This
language provides commands to insert another HTML page, which is
called \textbf{Widget}.

\subsection{Widgets}

A \textbf{Widget} is an object which can be inserted into a web site.
It is rendered by a Widget server into HTML.

We do not assume that we can trust the widget server.  As a
consequence, we have to ensure that a malicious widget server cannot
compromise the security of \emph{beng-proxy}, the client or even other
widget servers.

There is a global registry for well-known preconfigured widgets.  The
user can also choose to run his own (non-registered) widget server.
In fact, any public HTTP server should be able to act as a widget
server.


\subsection{Cookies}

\emph{beng-proxy} can be accessed with cookies switched off.  It includes a
full-featured session management and provides cookies for the widget
servers.

\emph{beng-proxy} maintains the client's session id in either a cookie
or as part of the URI.  In its local session storage, it holds all
cookies which were created by the widget servers.  This way, the
client gets to see only the one session id, disregarding how much
session information may be managed by \emph{beng-proxy}.


\subsection{JavaScript}

Since all widgets are put together into a single HTML page, all of the
JavaScript runs in the same security context.  That will open the door
for malicious widget servers, which are now able to take over the full
web site, including all other widgets.  For that reason, JavaScript is
only allowed for very few well-known and trusted widget servers.  For
all other widget servers, JavaScript use is rejected, or it must be
embedded in an IFRAME, which has technical and practical
disadvantages.


\subsection{Forms}

\emph{beng-proxy} itself does not use the HTTP query string or POST
data.  All of it can be handed off to a widget.  To enable this,
\emph{beng-proxy} rewrites forms, and remembers which widget server to
send the data to.


\subsection{Local files}

By default, \emph{beng-proxy} serves local files from
\texttt{/var/www}.

In contrast to most other web servers, \emph{beng-proxy} does not use
the file name to determine the \texttt{Content-Type} response header.
Instead, it reads this information from \textit{extended attributes}.
The programs \texttt{getfattr} and \texttt{setfattr} (Debian package
\texttt{attr}) enable you to read and write attributes:

\begin{verbatim*}
setfattr -n user.Content-Type -v "text/html; charset=utf8" \
/var/www/index.html
\end{verbatim*}

Some file systems need explicit support for extended attributes.  On
XFS, extended attributes are always enabled.


\section{Widget protocol}

A widget server is simply an HTTP server.  Its content type must be
text/html.  Alternatively, text/xml is allowed, but the caller must
specify an XSLT file for transformation to HTML.


\subsection{Hyperlinks}

A widget may provide hyperlinks, e.g. with anchor elements or with
FORM elements.

``Internal links'' are links which are relative to the widget's base
URI - these links can be loaded into the widget's dock.  In CGI, this
feature is called ``PATH\_INFO''.  An internal link may include a
query string.

``External URIs'' are not relative, they should
load in a new browser window.

\subsection{POSTing}

Making the browser send a request body with a POST request is
possible.  Note however that \emph{beng-proxy} may be very aggressive
about caching POST responses.  To prevent that, you should send a
``303 See Other'' redirect as a response to a POST request.  The same
is valid for every request which modifies a resource - always reckon
that \emph{beng-proxy} may request a resource multiple times, even
without interaction of the browser.

\subsection{Session tracking}

A widget may use HTTP cookies for session tracking, even if the
browser does not support it - \emph{beng-proxy} will take care of it.
The widget should not include some kind of session identification in
the URI.

Cookies are not available in JavaScript.

\subsection{Authentification}

Authentification is not yet supported.

\subsection{Payment}

It is planned to make \emph{beng-proxy} support pay-per-view widgets
(the webmaster paying to the widget provider).  No further details are
known yet.


\section{The Beng Template Language}

The \emph{Beng} template language defines commands which may be
inserted in the form of XML processing instructions.

\subsection{Adding a widget}

To add a widget, insert the following command:

\begin{verbatim*}
<c:widget id="foo" href="http://cfatest01.intern.cm-ag/date.py" />
\end{verbatim*}

The following attributes may be specified:

\begin{tabular}{|l|p{8cm}|}
\hline
\texttt{id} & unique identification of this widget; this is required
for proper session and form management if there are several widgets
with the same server URI \\
\hline
\texttt{name} & registered name of the widget server \\
\hline
\texttt{href} & use an unregistered widget \\
\hline
\texttt{path\_info} & optional path info to append to the widget URI;
must begin with a slash \\
\hline
\texttt{query\_string} & optional query string to append to the widget
URI (without the question mark) \\
\hline
\texttt{display} & specifies how the widget is to be displayed:
\texttt{inline} is the default, and inserts the widget's HTML code
into the current page; \texttt{iframe} puts the widget into an
\texttt{IFRAME}; \texttt{img} means the widget generates an image, and
it will be referenced from an \texttt{IMG} element \\
\hline
\texttt{width}, \texttt{height} & dimensions of the widget \\
\hline
\end{tabular}


\end{document}
