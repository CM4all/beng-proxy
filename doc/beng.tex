\documentclass[a4paper,12pt]{article}
\usepackage[pdftex,bookmarks]{hyperref}
\usepackage{longtable}

\setlength\LTleft{0pt}
\setlength\LTright{0pt}

\begin{document}
\title{CM4all Beng}
\author{Max Kellermann}

\maketitle

\begin{abstract}
Beng proxy is an HTTP server including an HTTP proxy and a
minimalistic template processor.  Its goal is to dynamically aggregate
a web site from a number of sources (widgets).
\end{abstract}

\setcounter{tocdepth}{2}
\tableofcontents
\newpage

\section{Features}

Beng-proxy delivers resources via HTTP.  In the most simple form, it
it provides a resource in pass-through mode, acting as an HTTP proxy.

It caches resources if possible.

It can filter any resources by POSTing it to a HTTP server,
e.g. to apply XSLT to a XML resource.

On HTML resources, it can apply a simple template language.  This
language provides commands to insert another HTML page, which is
called \textbf{Widget}.

\subsection{Widgets}

A \textbf{Widget} is an object which can be inserted into a web site.
It is rendered by a Widget server into HTML.

We do not assume that we can trust the widget server.  As a
consequence, we have to ensure that a malicious widget server cannot
compromise the security of \emph{beng-proxy}, the client or even other
widget servers.

There is a global registry for well-known preconfigured widgets.  The
user can also choose to run his own (non-registered) widget server.
In fact, any public HTTP server should be able to act as a widget
server.


\subsection{Cookies}

\emph{beng-proxy} can be accessed with cookies switched off.  It includes a
full-featured session management and provides cookies for the widget
servers.

\emph{beng-proxy} maintains the client's session id in either a cookie
or as part of the URI.  In its local session storage, it holds all
cookies which were created by the widget servers.  This way, the
client gets to see only the one session id, disregarding how much
session information may be managed by \emph{beng-proxy}.


\subsection{JavaScript}

Since all widgets are put together into a single HTML page, all of the
JavaScript runs in the same security context.  That will open the door
for malicious widget servers, which are now able to take over the full
web site, including all other widgets.  For that reason, only
well-known and trusted widget servers should be allowed to be inlined.
All other widget must be embedded in an IFRAME in another domain.


\subsection{Forms}

\emph{beng-proxy} itself does not use the query string and the request
body.  Both is forwarded to the ``focused'' widget.  See \ref{focus}
for information on widget focus.


\section{Installation}

\emph{beng-proxy} requires a Debian Lenny operating system: Linux
kernel 3.0 and glibc 2.11.  For compiling the source code, you need
a C99 compiler, e.g. gcc 4.6.

Install the package \texttt{cm4all-beng-proxy} and the translation
server of your choice.  Edit the file
\texttt{/etc/default/cm4all-beng-proxy}, and set the port number and
the path of the translation server socket.  Set the \texttt{WORKERS}
variable to the number of CPU cores in that server (or up to twice as
large).  Finally, restart \emph{beng-proxy}:

\begin{verbatim*}
/etc/init.d/cm4all-beng-proxy restart
\end{verbatim*}

\subsection{Configuration options}

The command line argument \texttt{--set} allows you to tweak some
settings:

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|session_cookie| & The name of the session cookie.  The
default value is ``beng\_proxy\_session''. \\ \hline

\verb|dynamic_session_cookie| & Append a suffix to the session cookie
generated from the ``Host'' request header if set to \texttt{yes}.
This is a measure to increase sessions separation of different hosts
under the same domain, accounting for mainstream user agents that are
known to ignore the ``Domain'' cookie attribute.  It is not guaranteed
to be collision-free.  \\ \hline

\verb|session_idle_timeout| & After this duration (in seconds), a
session expires, unless it gets refreshed by a request. \\

\hline

\verb|max_connections| & The maximum number of incoming HTTP
connections. \\
\hline

\verb|tcp_stock_limit| & The maximum number of outgoing TCP
connections per remote host.  0 means unlimited, which has shown to be
a bad choice, because many servers do not scale well. \\

\hline

\verb|fastcgi_stock_limit| & The maximum number of child processes
for one FastCGI application.  0 means unlimited. \\

\hline

\verb|fastcgi_stock_max_idle| & The maximum number of idle child
processes for one FastCGI application.  If there are more than that, a
timer will incrementally kill excess processes. \\

\hline

\verb|was_stock_limit| & The maximum number of child processes for
one WAS application.  0 means unlimited. \\

\hline

\verb|was_stock_max_idle| & The maximum number of idle child processes
for one WAS application.  If there are more than that, a timer will
incrementally kill excess processes. \\

\hline

\verb|http_cache_size| & The maxmimum amount of memory used by the
HTTP cache.  Set to 0 to disable the HTTP cache.  This option cannot
be used together with \texttt{--memcached-server}. \\

\hline

\verb|filter_cache_size| & The maxmimum amount of memory used by
the filter cache.  Set to 0 to disable the filter cache. \\

\hline

\verb|translate_cache_size| & The maxmimum number of cached
translation server responses.  Set to 0 to disable the translate
cache. \\

\hline

\verb|stopwatch| & Set to \texttt{yes} to enable the stopwatch.  See
\ref{stopwatch} for details. \\

\hline

\verb|dump_widget_tree| & Set to \texttt{yes} to dump the widget
tree for each request into the log file. \\

\hline

\verb|verbose_response| & Set to \texttt{yes} to reveal internal error
messages in HTTP responses. \\

\hline

\verb|session_save_path| & A file path where all sessions will be
saved periodically and on shutdown.  On startup, it will attempt to
load the sessions from there.  This option allows restarting the
server without losing sessions.  \\

\hline
\end{longtable}

\label{memcached}
You may specify \texttt{--memcached-server} followed by a server name.
This disables the local heap cache, and allows \emph{beng-proxy} to
share the cache with several (distributed) workers.  With the local
heap cache disabled, all of its configuration options are ignored.

\label{bulldog}
With \texttt{--bulldog-path}, \emph{beng-proxy} reads status
information on servers it contacts from the Bulldog-Tyke data
directory.

\subsection{User-Agent classification}
\label{uaclass}

The option \texttt{--ua-classes} sets the file that contains mappings
from \texttt{User-Agent} request headers to classification tokens,
example:

\begin{verbatim*}
m, Firefox/, firefox
/Safari/ safari
/MSIE/ ie
\end{verbatim*}

The first column is a regular expression which is delimited by two
slashes or by a custom delimiter introduced by \texttt{m} (syntax
borrowed from Perl).  The second column is the class name, consisting
of ASCII letters and digits.  This name gets sent to the translation
server in a \verb|UA_CLASS| packet.

\subsection{Cluster Options}

To run \emph{beng-proxy} as a \emph{beng-lb} cluster node with sticky
sessions, each node needs special configuration.  It needs to generate
new session numbers in a way that allows \emph{beng-lb} to derive the
cluster node from it.

To do that, specify the two command line options
\texttt{--cluster-size} and \texttt{--cluster-node} to each
\emph{beng-proxy} node.  Example for a cluster with 3 nodes:

\begin{verbatim*}
first# cm4all-beng-proxy --cluster-size=3 --cluster-node=0 ...
second# cm4all-beng-proxy --cluster-size=3 --cluster-node=1 ...
third# cm4all-beng-proxy --cluster-size=3 --cluster-node=2 ...
\end{verbatim*}

Each node number is assigned to exactly one cluster node.

The according \texttt{lb.conf} would look like this:

\begin{verbatim*}
pool foo {
  sticky "session_modulo"
  member first:http
  member second:http
  member third:http
}
\end{verbatim*}

The ordering of nodes matters.  \emph{beng-lb} assumes that the first
node runs with \texttt{--cluster-node=0}, the second node runs with
\texttt{--cluster-node=1} and so on.

\section{Running}

\subsection{Signals}

\texttt{SIGTERM} on the master process initiates shutdown.

On \texttt{SIGHUP}, the error log file is reopened and all caches are
flushed.


\section{Tuning}

\subsection{Optimized Build}

The default package \texttt{cm4all-beng-proxy} is built with debugging
code enabled.  It is about 2-10 times slower than the optimized build.
If performance really counts, you should install the package
\texttt{cm4all\--beng\--proxy\--optimized} instead (and restart the
daemon).

To switch back to the debug build, uninstall
\texttt{cm4all\--beng\--proxy\--op\-ti\-mi\-zed} and then reinstall
\texttt{cm4all\--beng\--proxy} to get the old
\texttt{/usr/sbin/cm4all\--beng\--proxy} back.  Finally, restart the
daemon.

\subsection{Resource Limits}

\emph{beng-proxy} needs to open a lot of file handles at a time,
because it serves many connections in one process.  Make sure that the
file handle limit is adequate.  The default init script sets it to
65536.  The only reason set that limit at all is to detect bugs (file
descriptor leaks).

Keep in mind that \emph{beng-proxy} may open more than one file
descriptor per connection.  For example, a connection to a WAS
application needs 3 file descriptors.

\subsection{Connection Limits}

\emph{beng-proxy} is very good at managing lots of incoming
connections, and manages system resources economically.  The default
value is 8192.

There are good reasons to limit the number of outgoing connections per
host (\verb|tcp_stock_limit|): most servers don't handle so many
connections as well as \emph{beng-proxy}, and performance degrades
when there are too many.  By default, there is no limit.

\subsection{Firewall}

Benchmarks have demonstrated that Netfilter (and its connection
tracking) account for a good amount of the CPU load on a busy server.
A good server does not need to depend on a firewall for security:
rather than blocking protocols and ports, the administrator should
make sure that these services aren't bound to public interfaces in the
first place.  An internal services bound on all interfaces is an
indicator for misconfiguration.

It is a good idea to disable the firewall (in the kernel
configuration) and audit all listeners.  If you cannot do without a
firewall, you can disable connection tracking for \emph{beng-proxy}
connections:

\begin{verbatim*}
table raw {
  chain PREROUTING proto tcp dport http NOTRACK;
  chain OUTPUT proto tcp sport http NOTRACK;
}
\end{verbatim*}

\subsection{Cacheable Widgets and Containers}

If you do a lot of direct communication with widgets, its container
should be cacheable.  If not, the container will be queried each time
a request for a widget is handled.  On pages with many widgets, you
should try to make all of them cacheable.  See \ref{caching} for
details.

\subsection{Disabling Widget Options}

Don't enable widget options when you don't need them.  That affects
the options ``processor'', ``container'', ``stateful'' and others.
Each of them adds some bloat to the response handler, and slows down
the application.  See \ref{registry} for details.

\subsection{Load Balancing}

If a machine serving a resource is too slow, you may be able to
parallelize its work.  Note that this increases throughput, but
usually does not reduce latency considerably.  See \ref{balancing}.

\subsection{The Stopwatch}
\label{stopwatch}

The stopwatch measures the latency of external resources (e.g. remote
HTTP servers, CGI and pipe programs).  It is only available in the
debug build (compile-time option \texttt{--enable-stopwatch}).

Example output:

\begin{verbatim*}
stopwatch[172.30.0.23:80 /test.py]: request=5ms headers=85ms
end=88ms (beng-proxy=1+2ms)
\end{verbatim*}

Here, the HTTP request to \texttt{172.30.0.23:80} was sent within 5
milliseconds.  After 85 milliseconds, the response headers were
received, and after 3 more milliseconds, the response body was
received.  All of these refer to wallclock time, relative to the start
of the operation.  Each client library may have its own set of
breakpoints.

During this HTTP request, \emph{beng-proxy} consumed 3 milliseconds of
raw CPU time (not wallclock time): 1 millisecond in user space, and 2
milliseconds for the kernel.

\section{Resources}

\emph{beng-proxy} delivers resources to its HTTP clients.  It obtains
these resources from several sources.

\subsection{Static files}
\label{static}

Local ``regular'' files can be served by \emph{beng-proxy}.  This is
the fastest mode, and should be preferred, if possible.  The
\texttt{Range} request header is supported (bytes only).

\subsubsection{Content type}

\label{xattr}

In contrast to most other web servers, \emph{beng-proxy} does not use
the file name to determine the \texttt{Content-Type} response header.
Instead, it reads this information from \textit{extended attributes}.
The programs \texttt{getfattr} and \texttt{setfattr} (Debian package
\texttt{attr}) enable you to read and write attributes:

\begin{verbatim*}
setfattr -n user.Content-Type -v "text/html; charset=utf8" \
/var/www/index.html
\end{verbatim*}

Some file systems need explicit support for extended attributes (mount
option \texttt{user\_xattr}).  On
XFS, extended attributes are always enabled.

\subsubsection{ETag}

The \texttt{ETag} response header is read from the \texttt{user.ETag}
extended attribute (see \ref{xattr}).  If none is present, it is
generated from the inode number and the modification time.  The request
headers \texttt{If-Match} and \texttt{If-None-Match} are supported.

\subsubsection{Expires}

If the \texttt{user.MaxAge} attribute exists, it is parsed as a
decimal integer.  The \texttt{Expires} response header is then
generated by adding this number of seconds to the current time stamp.
The maximum accepted value for \texttt{user.MaxAge} is one year.

\subsubsection{Directory index}

For security (by obscurity) reasons, \emph{beng-proxy} has no code for
generating directory listings.

\subsection{Delegates}
\label{delegate}

A ``delegate'' is a helper program which opens a local file and passes
the file descriptor to \emph{beng-proxy}.  The major reason for using
a delegate is to take advantage of the kernel's validation: the
delegate program may run with different privileges, different resource
limits or in a chroot/vserver.

The delegate reads requests on standard input.  The protocol is
similar to the translation protocol.  The file descriptor is sent to
\emph{beng-proxy} in a \texttt{SOL\_SOCKET} ancillary message.

If the \texttt{DELEGATE} translation packet was followed by a
\texttt{DOCUMENT\_ROOT} packet, then all helper processes are grouped
by their document root, and the \texttt{DOCUMENT\_ROOT} environment
variable is set.  In this case, it is possible to run the delegate
helper inside JailCGI by specifying the \texttt{JAILCGI} packet.

\subsection{HTTP proxying}
\label{http}

\emph{beng-proxy} implements an HTTP client, which allows it to act as
a reverse HTTP proxy server.  You should never make \emph{beng-proxy}
connect to itself.

\subsubsection{Caching}
\label{caching}

Responses from the remote servers are cached, if possible.  To allow
proper caching, the remote server must set the response headers
\texttt{Last-Modified}, \texttt{Expires} and \texttt{ETag} properly.
Additionally, they should understand the according request headers
\texttt{If-Modified-Since} and \texttt{If-Unmodified-Since},
\texttt{If-Match}, \texttt{If-None-Match}.

The cache is local to a \emph{beng-proxy} worker.  To share the cache
across workers and even across hosts, you may use a memcached server
(see \ref{memcached}).

\subsubsection{Connection pooling}

\emph{beng-proxy} attempts to use HTTP 1.1 keep-alive, to be able to
reuse existing connections to a remote server.

\subsubsection{Load balancing, failover}
\label{balancing}

For a remote URL, more than one server may be specified.
\texttt{beng-proxy} tries to use all of these equally.  If one server
fails on the socket level, \texttt{beng-proxy} ignores it for a short
amount of time.

Advanced users may take advantage of Bulldog-Tyke data, by passing
the option \texttt{--bulldog-path} (see \ref{bulldog}).

\subsubsection{Forwarded headers}

Not all request and response headers are forwarded, for various
reasons:

\begin{itemize}
\item hop-by-hop headers (RFC 2616 13.5.1) must not be forwarded
\item headers describing the body are not forwarded if there is no
  body
\item cookie forwarding and \texttt{beng-proxy}'s own session
  management are mutually exclusive
\item some headers reveal otherwise private information about the
  communication partner at the other end (e.g. IP address)
\item some servers rely on the authenticity of the
  \texttt{X-CM4all-BENG-User} header
\item due to imponderable security implications, much of the header
  forwarding is opt-in
\end{itemize}

By default, only the following original request headers are forwarded
to the remote HTTP server:

\begin{itemize}
\item the \texttt{Accept-*} headers
\item \texttt{User-Agent}
\item \texttt{Cache-Control}
\item in the presence of a forwarded request body:
  \texttt{Content-Type} and the other \texttt{Content-*} headers
\item \texttt{Cookie2} is taken from the current session
\end{itemize}

Response headers forwarded to \texttt{beng-proxy}'s client:

\begin{itemize}
\item \texttt{Age}, \texttt{ETag}, \texttt{Cache-Control},
  \texttt{Last-Modified}, \texttt{Retry-After}, \texttt{Vary},
  \texttt{Location}
\item \texttt{Content-Type} and the other \texttt{Content-*} headers
\item \texttt{Set-Cookie2} is generated from the current session
\end{itemize}

The translation server can change the header forwarding policy, see
\ref{tfwdheader}.

\subsubsection{SSL/TLS}

To enable SSL/TLS, specify a \texttt{https://} URL in the \verb|HTTP|
packet.

\subsection{AJP v1.3}
\label{ajp}

Similar to HTTP proxying, \emph{beng-proxy} can act as a HTTP-to-AJP
bridge.

The AJP client also supports caching, connection pooling and load
balancing.

\subsection{CGI and FastCGI}
\label{cgi}

Local CGI programs may be used to generate dynamic resources.
\emph{beng-proxy} supports running these with JailCGI.

CGI/FastCGI resources are cached in the same manner as remote HTTP
resources.

\subsection{WAS}
\label{was}

Web Application Socket (WAS) is a protocol that can let a child process
render a resource, similar to FastCGI.  Unlike FastCGI, it copies raw
data through separate pipes, which allows using the \texttt{splice()}
system call for efficient zero-copy transfer.

\subsection{Pipe filters}
\label{pipe}

A pipe is a program which filters a resource by reading it from
standard input, and writing the result to standard output.  This
option cannot be used to generate a resource, but only for resource
filters.  The same can be achieved with CGI, but pipes are simpler to
implement, because they do not need to bother with HTTP status code
and headers.

\subsection{NFS}
\label{nfs}

When compiled with \texttt{libnfs} support (\texttt{--enable-nfs}),
\emph{beng-proxy} can serve files right from a NFSv3 server without
having to mount it locally.  The NFS server must accept ``insecure''
connections, that is connections from non-privileged source ports.
Don't fear, calling it ``insecure'' is an exaggeration; that option's
name was chosen long ago, when people thought the concept of
``privileged ports'' would benefit security.

Three translation response packets are necessary to construct an NFS
resource address; example:

\begin{verbatim}
NFS_SERVER "1.2.3.4"
NFS_EXPORT "/srv/nfs/foo"
PATH "/index.html"
\end{verbatim}

This mounts the path \texttt{/srv/nfs/foo} from server
\texttt{1.2.3.4} and serves the file \texttt{index.html}.  The
leading slashes are necessary.

The options above are compatible with \verb|BASE| and
\verb|EXPAND_PATH|.

\subsection{Local HTTP}
\label{lhttp}

``Local HTTP'' is a way for \emph{beng-proxy} to launch local HTTP
servers.  An address for a ``local HTTP'' resource contains at least:

\begin{itemize}
\item a server program
\item a request URI
\end{itemize}

Optional attributes:

\begin{itemize}
\item command-line arguments (one or more \verb|APPEND| packets)
\item a ``Host'' request header (packet \verb|LHTTP_HOST|)
\item JailCGI configuration (packet \verb|JAILCGI|)
\item concurrency (packet \verb|CONCURRENCY|)
\end{itemize}

How it works: \emph{beng-proxy} spawns the specified process with a
bound listener socket on file descriptor 0.  The server program then
accepts regular HTTP connections on this listener socket.

\section{Translation}

\emph{beng-proxy} knows two ways to locate the resource a request URI
points to:

\begin{itemize}
\item via an external translation server
\item static translation
\end{itemize}

The latter is only for debugging.  The URI path is appended to the
document root (\texttt{/var/www} by default).  For security (by
obscurity) reasons, \emph{beng-proxy} has no code for generating
directory listings.  If the request has a trailing slash,
\emph{beng-proxy} looks for a file named \texttt{index} or
\texttt{index.html} and serves it.  Without the trailing slash,
\emph{beng-proxy} refuses to handle the request.

The translation server should be the default on production servers.
It is a daemon on the same physical machine which does all the
translation work for us.  \emph{beng-proxy} connects to a Unix socket
to contact this translation server.

A request may consist of several micro commands.  The request is
initialized with the \texttt{BEGIN} command, which is followed by any
number of commands which provide parameters.  After all parameters
have been transferred, the client sends the \texttt{END} command,
and waits for the server's response.

The client can send any number of requests over the socket until one
side closes the connection.

\subsection{Example conversation}

\begin{itemize}
\item client sends \verb|BEGIN| ``\textbackslash{}x03''
\item client sends \verb|REMOTE_HOST| ``192.168.1.77:1234''
\item client sends \verb|HOST| ``www.example.com''
\item client sends \verb|URI| ``/foo/index.html''
\item client sends \verb|END|
\item server sends \verb|BEGIN| ``\textbackslash{}x01''
\item server sends \verb|PATH| ``/var/www/foo/index.html''
\item server sends \verb|CONTENT_TYPE| ``text/html; charset=utf8''
\item server sends \verb|PROCESS|
\item server sends \verb|END|
\end{itemize}

\subsection{Command packets}

The protocol is binary and uses host byte order.  A command packet may
look like this in pseudo C:

\begin{verbatim}
struct beng_proxy_translate_packet {
    uint16_t length;
    uint16_t command;
    char payload[length];
};
\end{verbatim}

The \texttt{length} only refers to the payload.  The maximum supported
payload size is 65535 bytes.

Most parameters are ASCII strings; in this case, the payload contains
just the raw string, without terminating zero.

\subsection{Request}

\begin{longtable}{|l|p{10cm}|}
\hline

\verb|BEGIN| & Begins the request.  The payload is a 8-bit unsigned
integer specifying the protocol version.  The protocol version
described here is 3. \\

\hline

\verb|END| & Finishes the request. \\

\hline

\verb|LISTENER_TAG| & The ``tag'' of the listener that accepted the
connection.  The can can be specified in the \texttt{--listen}
setting, for example: \texttt{--listen TAG=192.168.1.99:80} (This
packet optional and is only submitted if requested via \verb|WANT|,
see page \pageref{want}) \\

\hline

\verb|LOCAL_ADDRESS| & The local socket address the request was
received on.  The payload is a \texttt{struct sockaddr}.
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline

\verb|REMOTE_HOST| & the client's address or host name and the port
number (as string)
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline
\verb|HOST| & the \texttt{Host} HTTP request header \\
\hline
\verb|URI| & the raw URI from the HTTP request (without the query
string) \\
\hline

\verb|QUERY_STRING| & the query string from request URI, without
the question mark
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline
\verb|SESSION| & a session identifier generated by the translation
server, see section \ref{sessions} \\
\hline
\verb|PARAM| & a parameter passed by the browser \\

\hline

\verb|USER_AGENT| & the \texttt{User-Agent} request header sent by
the client (not in the widget registry)
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline

\verb|USER| & the user name currently logged in using \verb|AUTH|; see
page \pageref{auth} (This packet optional and is only submitted if
requested via \verb|WANT|, see page \pageref{want}) \\

\hline

\verb|UA_CLASS| & a classification token of the \texttt{User-Agent}
request header sent by the client.  See \ref{uaclass} for more
information.
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline

\verb|LANGUAGE| & the \texttt{Accept-Language} request header sent
by the client (not in the widget registry)
(This packet optional and is only submitted if requested via
\verb|WANT|, see page \pageref{want}) \\

\hline

\verb|AUTHORIZATION| & the \texttt{Authorization} request header
sent by the client (see RFC 2617) \\

\hline

\verb|CONTENT_TYPE_LOOKUP| & Look up the \texttt{Content-Type} of a
file name suffix.  See \ref{ctlookup} for a detailed description. \\

\hline

\verb|SUFFIX| & The file name suffix without the dot for
\verb|CONTENT_TYPE_LOOKUP|.  See \ref{ctlookup} for a detailed
description. \\

\hline

\verb|ERROR_DOCUMENT| & a resource has failed, and the translation
server is asked to provide the location of the error document.  This
is followed by the packets \verb|URI| and \verb|STATUS|.  See
\ref{errdoc} for a detailed description. \\

\hline

\verb|PROBE_PATH_SUFFIXES| & Result of \verb|PROBE_PATH_SUFFIXES|.
This is an echo of the \verb|PROBE_PATH_SUFFIXES| from the previous
translation response.  If a file with one of the given suffixes
exists, then \verb|PROBE_SUFFIX| specifies the first existing suffix.
If no \verb|PROBE_SUFFIX| follows, then no file was found.  \\

\hline

\verb|FILE_NOT_FOUND| & The specified file does not exist.  The
translation server is asked to provide an alterate translation.  This
is an echo of the \verb|FILE_NOT_FOUND| from the previous translation
response. \\

\hline

\verb|ENOTDIR| & The specified file does not exist, but a portion of
the path points to a regular file.  This is an echo of the
\verb|ENOTDIR| packet from the previous translation response.  The
given URI has been shortened: the last slash and what follows has been
moved to \verb|PATH_INFO|.  This may be repeated until the regular
file has been found. \\

\hline

\verb|DIRECTORY_INDEX| & The specified file is a directory.  The
translation server is asked to provide an alterate translation.  This
is an echo of the \verb|DIRECTORY_INDEX| from the previous translation
response. \\

\hline

\label{want}
\verb|WANT| & causes \emph{beng-proxy} to submit the same translation
request again, with this packet echoed plus the requested packets.
The payload is an array of 16-bit integers with requested packet ids.
The following packets are allowed/supported here:
\verb|LISTENER_TAG|,
\verb|LOCAL_ADDRESS|, \verb|REMOTE_HOST|, \verb|USER_AGENT|,
\verb|USER|,
\verb|UA_CLASS|, \verb|LANGUAGE|, \verb|ARGS|, \verb|QUERY_STRING| \\

\hline

\verb|WANT_FULL_URI| & causes beng-proxy to submit the same
translation request again, with this packet appended (its payload is
opaque to \emph{beng-proxy}), and with the full request URI (including
semicolon-arguments and the follow-up suffix, but excluding the query
string). \\

\hline

\verb|INTERNAL_REDIRECT| & causes beng-proxy to submit the same
translation request again, with this packet appended (its payload is
opaque to \emph{beng-proxy}).  However, instead of the original
request URI, \emph{beng-proxy} uses the one from this responses's
\verb|URI| or \verb|EXPAND_URI| packet. \\

\hline

\verb|CHECK| & causes beng-proxy to submit the same translation
request again, with this packet appended (its payload is opaque to
\emph{beng-proxy}).  The current response is remembered, to be used
when the second response contains the \verb|PREVIOUS| packet.  This
can be used to implement authentication (see \ref{authentication}). \\

\hline

\verb|AUTH| & Indicates that authentication is necessary (see
\ref{auth}). \\

\hline

\verb|READ_FILE| & This is a repeated translation in reply to a
translation response with a \verb|READ_FILE| packet.  The payload is
the file contents or empty if the file does not exist (or if there was
another problem reading the file).  This packet is implicitly on
``vary''.  \\

\hline

\end{longtable}

\subsection{Response}
\label{tresponse}

\begin{longtable}{|l|p{8cm}|}

\hline

\verb|BEGIN| & Begins the response.  The payload is a 8-bit unsigned
integer specifying the protocol version.  The initial protocol version
is 0. \\

\hline

\verb|ENDS| & Finishes the response. \\

\hline

\verb|URI| & the ``real'' raw URI from the HTTP request (without the
query string); this is used to override the URI, e.g. when
\emph{beng-proxy} is behind another proxy which modifies the URI \\

\hline

\verb|EXPAND_URI| & Override \verb|URI| with the given value (after
expanding). \\

\hline

\verb|HOST| & the host name for generating absolute URLs; default is
the \texttt{Host} HTTP request header \\

\hline

\verb|SCHEME| & the scheme for generating absolute URLs; default is
\texttt{http}.  This packet is useful if \emph{beng-proxy} is behind
\texttt{stunnel} \\

\hline

\verb|UNTRUSTED| & sets the ``untrusted'' host name for this
request: only untrusted widgets matching this host name are allowed.
Trusted widgets are rejected. \\

\hline
\verb|STATUS| & HTTP status code, encoded as \texttt{uint16\_t};
this parameter is usually not used \\
\hline

\hline

\verb|HTTP| & this URL parameter may be specified instead of
\verb|PATH| to tell \emph{beng-proxy} to obtain the resource from a
remote HTTP server (see \ref{http}) \\

\hline

\verb|AJP| & Load the resource from an AJPv13 server (see
\ref{ajp}).  The payload of this packet is an absolute URI in the form
\texttt{ajp://host:port/path} \\

\hline

\verb|PIPE| & a local program which reads input from stdin and
prints the modified resource on stdout (see \ref{pipe}). \\

\hline

\verb|NFS_SERVER| & Mount the specified NFS server (see \ref{nfs}).
The payload is a string specifying the server's IP address. \\

\hline

\verb|NFS_EXPORT| & Mount the specified path from the NFS server
specified right before this packet (see \ref{nfs}) \\

\hline

\verb|LHTTP_PATH| & a local path which is executed as HTTP server \\

\hline

\verb|LHTTP_URI| & the request URI for \verb|LHTTP_PATH| \\

\hline

\verb|EXPAND_LHTTP_URI| & the regular expression rule for
\verb|LHTTP_URI| \\

\hline

\verb|LHTTP_HOST| & the ``Host'' request header for \verb|LHTTP_PATH|
\\

\hline

\verb|CONCURRENCY| & a 16 bit integer specifying the maximum number of
concurrent requests to this server (LHTTP only currently) \\

\hline

\verb|NON_BLOCKING| & If present, make the socket passed to a child
process non-blocking (LHTTP only currently).  This is needed by NodeJS
0.12. \\

\hline

\verb|CGI| & a local path which is executed as CGI script (see
\ref{t-cgi}) \\

\hline

\verb|FASTCGI| & a local path which is executed as FastCGI script (see
\ref{t-cgi}) \\

\hline

\verb|WAS| & a local path which is executed as WAS application (see
\ref{t-cgi}) \\

\hline

\verb|REDIRECT| & another alternative to \verb|PATH|: redirect the
HTTP client to this URL; \verb|STATUS| must be set to one of the
HTTP 3xx codes \\

\hline

\verb|EXPAND_REDIRECT| & Override \verb|REDIRECT| with the given value
(after expanding); see \ref{tresponse}. \\

\hline

\verb|REDIRECT_QUERY_STRING| & Append the query string to the given
\verb|REDIRECT| URL. \\

\hline

\verb|BOUNCE| & Redirects the browser with a \texttt{303 See Other}
status to this URI, and appends the current absolute URI
(form-encoded).  This is useful to redirect to another server, which
will need to redirect back to the original URI. \\

\hline

\verb|EXPAND_PATH| & Override the \verb|PATH| with the given value
(applicable to static files, CGI, FastCGI, WAS, \verb|HTTP|,
\verb|AJP|).
Backslash references are expanded to the value of the match group of
\verb|REGEX|. In the presence of this packet, the URI suffix after the
base will not be appended to other paths.
The translation server is responsible for ensuring that the resulting
path cannot point to files that are not supposed to be published; for
example, \emph{beng-proxy} does not check for \texttt{/../} sequences.
\scriptsize{(Since version 2.0.5)} \\

\hline

\verb|SITE| & optional identification or name of the site this
resource belongs to \\

\hline

\verb|EXPAND_SITE| & provide a cache expansion for the preceding
\verb|SITE| \\

\hline

\verb|SESSION_SITE| & Set a \verb|SITE| for all requests in the
current session.  This packet with an empty payload can be used to
clear the session's \verb|SITE| value. \\

\hline

\verb|DOCUMENT_ROOT| & base directory of the site; may also be
passed after a \verb|CGI|/\verb|DELEGATE| command, to set the
document root only for this CGI/delegate \\

\hline

\verb|BASE| & Defines a realm in the URI space.  The payload
specifies the URI prefix (of the original request URI, ending with a
slash) which contains this
realm.  All resources in this realm can be addressed by
\emph{beng-proxy} with a trivial pattern: append the relative URI
(within the realm) to the resource address (e.g. the \verb|PATH|,
\verb|HTTP| or \verb|PATH_INFO| value).

The address in this response applies to request URI, not the
base URI (to allow backwards compatibility with translation clients
which do not support this packet).

Example: in the request, \verb|URI| is \texttt{/foo/bar/index.html};
in the response, \verb|PATH| is \texttt{/var/www/foo/bar/index.html}
and \verb|BASE| is \texttt{/foo/}.  The \emph{beng-proxy}
translation cache now knows: if a request on \texttt{/foo/test.png} is
received, it can serve \texttt{/var/www/foo/test.png} without querying
the translation server. \\

\hline

\verb|UNSAFE_BASE| & Modifier for \verb|BASE|: omit the security
checks.  This allows \verb|/../| to be part of the remaining URI,
possibly allowing clients to break out of the given directory. \\

\hline

\verb|EASY_BASE| & Modifier \verb|BASE| which aims to simplify its
usage: the resource address given in the response refers to the
\verb|BASE|, not to the actual request URI.  It is important to
include the trailing slash which is part of \verb|BASE| in the
resource address (e.g. \verb|BASE|=''/foo/'',
\verb|PATH|=''/var/www/foo/'').  \emph{beng-proxy} applies the URI
suffix before handling the HTTP request. \\

\hline

\verb|REGEX| & Reuse a cached response only if the request \verb|URI|
matches the specified regular expression (Perl compatible, anchored).
This works only when a BASE was specified.  \scriptsize{(Since version
  1.3.2)} \\

\hline

\verb|INVERSE_REGEX| & Don't apply the cached response if the request
\verb|URI| matches the specified regular expression (Perl compatible,
anchored). \scriptsize{(Since version 1.3.2)} \\

\hline

\verb|REGEX_TAIL| & Apply \verb|REGEX| and \verb|INVERSE_REGEX| to
the URI suffix following \verb|BASE| instead of the whole request URI.
\scriptsize{(Since version 4.0.21)} \\

\hline

\verb|REGEX_ON_HOST_URI| & Prepend the \texttt{Host} header to the
string used with \verb|REGEX| and \verb|INVERSE_REGEX|. \\

\hline

\verb|REGEX_ON_USER_URI| & Prepend the user name (from \verb|USER|)
and a '@' to the string used with \verb|REGEX| and
\verb|INVERSE_REGEX|. \\

\hline

\verb|FILTER| & the next resource address (\verb|HTTP|,
\verb|CGI|) will denote an output filter, see section \ref{filter}
\\

\hline

\verb|FILTER_4XX| & Enable filtering of client errors (status 4xx).
Without this flag, only successful responses (2xx) are filtered.  Only
useful when at least one \verb|FILTER| was specified. \\

\hline

\verb|PROCESS| & enables the \emph{beng-proxy} processor, see
section \ref{processor} \\

\hline

\verb|PROCESS_TEXT| & enables the \emph{beng-proxy} text processor
\scriptsize{(Since version 1.3.2)} \\

\hline

\verb|PROCESS_CSS| & enables the \emph{beng-proxy} CSS processor \\

\hline

\verb|DOMAIN| & the domain name for partitioned frames \\

\hline

\verb|SESSION| & a session identifier generated by the translation
server, see section \ref{sessions} \\

\hline

\verb|USER| & the user name associated with this session \\

\hline

\verb|REALM| & a realm name for this session.  An existing session
matches only if its realm matches the current request's realm.  If
this packet is not specified in the translation response, then the
``Host'' request header is used. \\

\hline

\verb|TRANSPARENT| & Transparent proxy: forward URI arguments to the
request handler instead of using them.  As a side effect, session
handling is disabled. \\

\hline

\verb|LANGUAGE| & overrides the \texttt{Accept-Language} request
header for this session \\
\hline

\verb|DISCARD_SESSION| & discard the current browser session \\

\hline

\verb|SECURE_COOKIE| & Set the "secure" flag on the session cookie. \\

\hline

\verb|JAILCGI| & enable JailCGI \\

\hline

\verb|HOME| & home directory of the account this site belongs to;
will be mounted in the jail; defaults to \verb|DOCUMENT_ROOT| \\

\hline

\verb|EXPAND_HOME| & Expansion for \verb|HOME|. \\

\hline

\verb|ADDRESS| & after each \verb|HTTP| packet, there must be one
or more \verb|ADDRESS| packets which specify the resolved addresses.
The payload of each is a \texttt{struct sockaddr}.
The same applies to \verb|AJP| packets. \\

\hline

\verb|STICKY| & Make the resource address "sticky", i.e. attempt to
forward all requests of a session to the same worker. \\

\hline

\verb|VIEW| & starts a new view; the body of the packet is the name
of the view (ASCII letters, digits, underscore, dash only).  Each view
can have different address/processor/filter settings.  The first view
(the one before the first \verb|VIEW| packet) is the default and has
no name. \\

\hline

\verb|MAX_AGE| & a 32 bit unsigned integer specifying the number of
seconds the preceding piece of information is valid without having to
revalidate.  A value of 0 specifies that \emph{beng-proxy} should not
remember this value at all.  Without this packet, the maximum age is
not limited.  Currently, this is only supported for the following
packets:

\verb|BEGIN| (refers to the whole translate response), \verb|USER|
\\

\hline

\verb|VARY| & similar to the HTTP \texttt{Vary} response header;
the payload contains an array of translation request commands which
this response depends upon.

The following request packets are currently supported:
\verb|PARAM|,
\verb|SESSION|,
\verb|LISTENER_TAG|, \verb|LOCAL_ADDRESS|,
\verb|REMOTE_HOST|, \verb|HOST|, \verb|LANGUAGE|,
\verb|USER_AGENT|, \verb|UA_CLASS|, \verb|QUERY_STRING|,
\verb|USER|,
\verb|INTERNAL_REDIRECT|,
\verb|ENOTDIR|.

The following request packets are on ``vary'' implicitly:
\verb|WIDGET_TYPE|, \verb|CONTENT_TYPE_LOOKUP|, \verb|URI|,
\verb|STATUS|, \verb|CHECK|, \verb|WANT_FULL_URI|,
\verb|PROBE_PATH_SUFFIXES|, \verb|PROBE_SUFFIX|,
\verb|FILE_NOT_FOUND|, \verb|DIRECTORY_INDEX|, \verb|WANT|.

\\

\hline

\verb|INVALIDATE| & Invalidates existing translation cache items
which depend on some of the request values.  The payload has the same
format as \verb|VARY|.  Additionally, the \verb|URI| command is
supported, to invalidate all items pointing to the request URI.

If you specify more than one command, all must match.  If you list a
command which was not specified in the request (or a command which is
not supported here), nothing will be deleted.

Example: \verb|INVALIDATE| on \verb|SESSION| invalidates all cache
items for the current session.

\\

\hline

\label{tfwdheader}
\verb|REQUEST_HEADER_FORWARD| &

This packet specifies which request headers are forwarded to the
request handler.  The payload is a list of group/mode pairs
(\texttt{struct beng\_header\_forward\_packet}).  Group is one of:

\begin{itemize}
\item \texttt{IDENTITY}: headers \texttt{Via} and
  \texttt{X-Forwarded-For}
\item \texttt{CAPABILITIES}: \texttt{Server}, \texttt{User-Agent},
  \texttt{Accept-*}
\item \texttt{COOKIE}: \texttt{Cookie[2]}, \texttt{Set-Cookie[2]}

\item \texttt{FORWARD}: forward information about the original
  request/response that would usually not be visible.  If set to
  \verb|MANGLE|, then \texttt{Host} is translated to
  \texttt{X-Forwarded-Host}.

\item \texttt{CORS}: forward
  \href{http://www.w3.org/TR/cors/#syntax}{CORS} request/response
  headers

\item \texttt{SECURE}: forward ``secure'' request/response headers
  such as \texttt{X-CM4all-BENG-User}

\item \texttt{TRANSFORMATION}: forward headers that affect the
  transformation (i.e. \texttt{X-CM4all-View})

\item \texttt{OTHER}: other end-to-end headers not explicitly
  mentioned here

\item \texttt{ALL}: all of the above except for \texttt{SECURE}

\end{itemize}

Mode is one of:

\begin{itemize}
\item \texttt{NO}: don't forward the headers
\item \texttt{YES}: forward the headers
\item \texttt{MANGLE}: \emph{beng-proxy} processes the headers
\item \texttt{BOTH}: both \emph{beng-proxy} and the backend server
  process the headers (special case for cookie headers, which is a
  combination of \texttt{YES} and \texttt{MANGLE})
\end{itemize}

\emph{beng-proxy}'s session management is only active when
\texttt{COOKIE} is \texttt{MANGLE} (which is the default) or
\texttt{BOTH}.  The behavior of the \texttt{COOKIE} setting on widgets
is undefined.

\\

\hline

\verb|RESPONSE_HEADER_FORWARD| &

Same as \verb|REQUEST_HEADER_FORWARD|, but applies to response
headers forwarded to the client. \\

\hline

\verb|WWW_AUTHENTICATE| & the \texttt{WWW-Authenticate} response
header sent to the client (see RFC 2617).  Currently, this is never
cached.  This exact behavior is subject to change in the future, and
will be cacheable. \\

\hline

\verb|AUTHENTICATION_INFO| & the \texttt{Authentication-Info}
response header sent to the client (see RFC 2617). \\

\hline

\verb|HEADER| & A custom HTTP response header sent to the client.
Name and value are separated by a colon (without any whitespace).
This will not override existing headers.  It is not allowed to set
hop-by-hop headers (RFC 2616 13.5.1) this way.  This packet shall only
be a last resort, when there is no other way to set a required
response header. \\

\hline

\verb|EXPAND_HEADER| & Same as \verb|HEADER|, but expand the value. \\

\hline

\verb|REQUEST_HEADER| & A custom HTTP request header for the backend
server.  Name and value are separated by a colon (without any whitespace).
This will not override existing headers.  It is not allowed to set
hop-by-hop headers (RFC 2616 13.5.1) this way. \\

\hline

\verb|EXPAND_REQUEST_HEADER| & Same as \verb|REQUEST_HEADER|, but
expand the value. \\

\hline

\verb|CONTENT_TYPE_LOOKUP| & Indicates that the translation server is
willing to look up \texttt{Content-Type} by file name suffix.  See
\ref{ctlookup} for a detailed description. \\

\hline

\verb|ERROR_DOCUMENT| & Indicates that the translation server is
willing to provide a custom error document.  See \ref{errdoc} for a
detailed description. \\

\hline

\verb|PROBE_PATH_SUFFIXES| & Check if the \verb|TEST_PATH| (or
\verb|EXPAND_TEST_PATH|) plus one of the suffixes from
\verb|PROBE_SUFFIX| exists (regular files only).  \emph{beng-proxy}
will send another translation request, echoing this packet and echoing
the \verb|PROBE_SUFFIX| that was found.  This packet must be followed
by at least two \verb|PROBE_SUFFIX| packets.  \\

\hline

\verb|FILE_NOT_FOUND| & Indicates that the translation server would
like to provide an alternate translation when the specified file does
not exist.  \emph{beng-proxy} will repeat the translation request with
this packet echoed.  This is supported by the following address types:
\verb|PATH|, \verb|CGI|, \verb|FASTCGI|, \verb|WAS|,
\verb|LHTTP_PATH|. \\

\hline

\verb|ENOTDIR| & Indicates that the translation server would like to
provide an alternate translation when the specified file does not
exist, but a portion of the path points to a regular file. \\

\hline

\verb|DIRECTORY_INDEX| & Indicates that the translation server would
like to provide an alternate translation when the specified file is a
directory.  \emph{beng-proxy} will repeat the translation request with
this packet echoed. \\

\hline

\verb|TEST_PATH| & Test the specified file.  If this packet is not
present, then the path from the resource address is used (\verb|PATH|,
\verb|CGI|, \verb|FASTCGI|, \verb|LHTTP_PATH|).  Affects the packets
\verb|FILE_NOT_FOUND|, \verb|DIRECTORY_INDEX|, \verb|ENOTDIR|. \\

\hline

\verb|EXPAND_TEST_PATH| & Override the \verb|TEST_PATH| with the
given value.  Backslash references are expanded to the value of the
match group of \verb|REGEX|.  \scriptsize{(Since version 4.0.34)} \\

\hline

\verb|COOKIE_DOMAIN| & Set the session cookie's "Domain" attribute. \\

\hline

\verb|COOKIE_HOST| & Override the cookie host name.  This host name
is used for storing and looking up cookies in the jar.  It is
especially useful for protocols that don't have a host name, such as
CGI. \\

\hline

\verb|EXPAND_COOKIE_HOST| & Expansion for \verb|COOKIE_HOST|. \\

\hline

\verb|COOKIE_PATH| & Override the cookie's \texttt{Path} attribute.
This is sent to the client when \emph{beng-proxy} generates a new
session cookie.  Be careful with overlapping locations that create
conflicting cookies. \\

\hline

\verb|VALIDATE_MTIME| & A cached response is valid only if the file
specified in this packet is not modified.
The first 8 bytes is the mtime (seconds since UNIX epoch), the rest is
the absolute path to a regular file (symlinks not supported).  The
translation fails when the file does not exist or is inaccessible.
The special value 0 matches only when the file does not exist; as soon
as the file appears, the cached response will be discarded. \\

\hline

\verb|READ_FILE| & Asks \emph{beng-proxy} to read the specified
(small) file and submit another translation request with the file
contents in another \verb|READ_FILE| packet. \\

\hline

\verb|EXPAND_READ_FILE| & Expansion for \verb|READ_FILE|. \\

\hline

\verb|PREVIOUS| & Tells beng-proxy to use the resource address of
the previous translation response.  Only allowed if the request
contains a \verb|CHECK| packet. \\

\hline
\end{longtable}

If the translation server does not provide the \verb|CONTENT_TYPE|
header, \emph{beng-proxy} will attempt to discover the file type from
its extended attributes (see \ref{xattr}).

To send a standard error page, the translation server sends a response
containing only the \verb|STATUS| parameter with the desired HTTP
status.

\subsection{Static files}
\label{tstatic}

See \ref{static} for an explanation of static file resources.

The response packet \verb|PATH| declares a static file that will be
served.  The following packets are available:

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|PATH| & Absolute path of the local file to be served. \\

\hline

\verb|EXPAND_PATH| & Override the path with the given value (after
expanding); see \ref{tresponse}. \\

\hline

\verb|DEFLATED| & Absolute path of a precompressed version of the
file.  The file is compressed with the ``deflate'' algorithm, without
\texttt{gzip} headers.  May follow the \verb|PATH| packet. \\

\hline

\verb|GZIPPED| & Absolute path of a precompressed version of the
file.  The file is compressed with \texttt{gzip}.  May follow the
\verb|PATH| packet. \\

\hline

\verb|AUTO_GZIPPED| & Build the precompressed path by appending
``\texttt{.gz}'' to the \verb|PATH|.  Unlike \verb|GZIPPED|, this is
compatible with \verb|BASE|. \\

\hline

\verb|AUTO_DEFLATE| & Deflate the response on-the-fly if the client
accepts it.  This consumes a lot of CPU and should only be used for
dynamic responses which can be compressed well. \\

\hline

\verb|AUTO_GZIP| & Compress the response on-the-fly if the client
accepts the \texttt{gzip} encoding.  This consumes a lot of CPU and
should only be used for dynamic responses which can be compressed
well. \\

\hline

\verb|CONTENT_TYPE| & MIME type of the file (optional) \\

\hline

\verb|EXPIRES_RELATIVE| & Generate an \texttt{Expires} response
header.  The payload is a 32 bit integer specifying the number of
seconds from now. \\

\hline
\end{longtable}

\subsection{Delegates}
\label{tdelegate}

If \verb|DELEGATE| follows after \verb|PATH|, then this file will be
opened through the ``delegate'' process.  See \ref{delegate} for an
explanation.

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|DELEGATE| & The payload is the path of the delegate program. \\

\hline

\verb|DOCUMENT_ROOT| & See \ref{tresponse}. \\

\hline

\verb|HOME| & See \ref{tresponse}. \\

\hline

\verb|JAILCGI| & enable JailCGI \\

\hline
\end{longtable}

See \ref{rlimits} for how to configure resource limits and \ref{ns}
for how to configure namespaces.

\subsection{Proxying requests}

When proxying HTTP requests with the a \verb|HTTP| packet,
\emph{beng-proxy} forwards the request to the specified location,
including the HTTP method and the request body.  There is one
exception: if \verb|PROCESS| is enabled and a widget is focused (see
\ref{focus}), the
other HTTP server receives a \verb|GET| request without a body,
because the focused widget is going to receive the request body.

If the filter URL starts with a slash, \emph{beng-proxy} assumes it is
the absolute path to a Unix socket.

\subsection{CGI, FastCGI, WAS and Pipe}
\label{t-cgi}

The protocols CGI, FastCGI and WAS can be used to generate or filter
resources (see \ref{cgi} and \ref{was}).  A ``pipe'' can be used as a
filter (see \ref{pipe}).  The following packets are used to choose the
protocol:

\begin{longtable}{|l|p{10cm}|}
\hline

\verb|CGI| & a local path which is executed as CGI script \\

\hline

\verb|FASTCGI| & a local path which is executed as FastCGI script.
To connect to an existing FastCGI server, specify one or more
\verb|ADDRESS| packets. \\

\hline

\verb|WAS| & a local path which is executed as WAS application \\

\hline

\verb|PIPE| & a local program which reads input from stdin and
prints the modified resource on stdout \\

\hline
\end{longtable}

The following packets can be used to specify more details:

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|EXPAND_PATH| & Override the executable path with the given value
(after expanding); see \ref{tresponse} \\

\hline

\verb|APPEND| & appends an argument to the command line \\

\hline

\verb|EXPAND_APPEND| & provide a cache expansion for the preceding
\verb|APPEND| \\

\hline

\verb|PAIR| & adds a FastCGI/WAS parameter in the form
\texttt{KEY=VALUE}. \\

\hline

\verb|EXPAND_PAIR| & provide a cache expansion for the preceding
\verb|PAIR| \\

\hline

\verb|SETENV| & adds an environment variable for CGI, FastCGI, WAS or
LHTTP in the form \texttt{KEY=VALUE}. \\

\hline

\verb|EXPAND_SETENV| & provide a cache expansion for the preceding
\verb|SETENV| \\

\hline

\verb|PATH_INFO| & optional URI substring which was left after
finding the file \\

\hline

\verb|EXPAND_PATH_INFO| & Override the \verb|PATH_INFO| with the given
value.  Backslash references are expanded to the value of the match
group of \verb|REGEX|. In the presence of this packet, the URI suffix
after the base will not be appended to other paths.
\scriptsize{(Since version 2.0.4)} \\

\hline

\verb|DOCUMENT_ROOT| & set the document root passed to this CGI
process \\

\hline

\verb|EXPAND_DOCUMENT_ROOT| & Override the \verb|DOCUMENT_ROOT| with
the given value.  Backslash references are expanded to the value of
the match group of \verb|REGEX|.
\scriptsize{(Since version 6.0)} \\

\hline

\verb|INTERPRETER| & run a CGI script with the specified
interpreter: invokes the specified interpreter with the mapped file
path added as a command-line argument.  This can be used to run Perl
scripts without setting the  ``execute'' bit. \\

\hline

\verb|ACTION| & run the specified CGI program instead of the mapped
file.  This program reads the mapped file path from
\verb|SCRIPT_FILENAME| and loads this script.  This is modeled after
the Apache directive \verb|Action|, and implements a protocol
understood by PHP and COMA. \\

\hline

\verb|SCRIPT_NAME| & the \verb|SCRIPT_NAME| environment variable
for a CGI \\

\hline

\verb|EXPAND_SCRIPT_NAME| & Override the \verb|SCRIPT_NAME| with the
given value.  Backslash references are expanded to the value of the
match group of \verb|REGEX|.  \scriptsize{(Since version 4.0.33)} \\

\hline

\verb|AUTO_BASE| & Auto-calculate the \verb|BASE| from
\verb|PATH_INFO| (only CGI, FastCGI and WAS) \\

\hline
\end{longtable}

See \ref{rlimits} for how to configure resource limits and \ref{ns}
for how to configure namespaces.

\subsection{Local HTTP}

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|APPEND| & appends an argument to the command line \\

\hline

\verb|EXPAND_APPEND| & provide a cache expansion for the preceding
\verb|APPEND| \\

\hline
\end{longtable}

See \ref{rlimits} for how to configure resource limits and \ref{ns}
for how to configure namespaces.

\subsection{Resource Limits}
\label{rlimits}

The packet \verb|RLIMITS| specifies Linux resource limits for child
processes.  Its payload is a string, a sequence of resource limit
codes and their respective limit values.  The following resource
limits are supported:

\begin{longtable}{|l|l|p{10cm}|}
\hline

\texttt{t} & \texttt{CPU} & CPU time limit in seconds. \\

\hline

\texttt{f} & \texttt{FSIZE} & The maximum size of files that the
process may create. \\

\hline

\texttt{d} & \texttt{DATA} & The maximum size of the process's data
segment. \\

\hline

\texttt{s} & \texttt{STACK} & The maximum size of the process stack,
in bytes. \\

\hline

\texttt{c} & \texttt{CORE} & Maximum size of core file. \\

\hline

\texttt{m} & \texttt{RSS} & The limit of the process's resident set,
in pages. \\

\hline

\texttt{u} & \texttt{NPROC} & The maximum number of processes that can
be created for the real user ID. \\

\hline

\texttt{n} & \texttt{NOFILE} & The maximum file descriptor number that
can be opened by this process. \\

\hline

\texttt{l} & \texttt{MEMLOCK} & The maximum number of bytes of memory
that may be locked into RAM. \\

\hline

\texttt{v} & \texttt{AS} & The maximum size of the process's virtual
memory (address space) in bytes. \\

\hline

\texttt{i} & \texttt{SIGPENDING} & The maximum number of signals that
may be queued. \\

\hline

\texttt{q} & \texttt{MSGQUEUE} & The maximum number of bytes that can
be allocated for POSIX message queues. \\

\hline

\texttt{e} & \texttt{NICE} & A ceiling to which the process's nice
value can be raised. \\

\hline

\texttt{r} & \texttt{RTPRIO} & Ceiling on the real-time priority that
may be set for this process. \\

\hline
\end{longtable}

The letter in the first column is the code for the payload, to be
followed by '!' (for ``unlimited'') or the numeric limit value (with
optional prefix ``K'', ``M'' or ``G'' for ``kibi'', ``mebi'',
``gibi'').

The limits are applied to both ``soft'' and ``hard'' by default.  The
code \texttt{S} changes all following specifications to ``soft'' only,
and \texttt{H} does the same for ``hard''.

Example:

\begin{verbatim}
c!Sv1Gn256Hn512
\end{verbatim}

Explanation:

\begin{itemize}
\item \verb|c!| unlimited core file size (both soft and hard)
\item \verb|S|: the following will be soft limits
\item \verb|v1G|: limit address space to $1 GiB$ (soft; the hard limit
  is unchanged)
\item \verb|n256|: maximum 256 file descriptors (soft)
\item \verb|H|: the following will be hard limits
\item \verb|n512|: maximum 256 file descriptors (hard)
\end{itemize}

\subsection{Refence}
\label{refence}

\emph{Refence} is a Linux security module that can put additional
limits on processes.  The packet \verb|REFENCE| enables it for a
certain child process.  The payload is a null-byte separated list of
\emph{Refence} commands to be written to
\texttt{/proc/cm4all/refence/self}.  Example:

\begin{verbatim}
limit fork 10\0limit kill enclosure\0limit ptrace deny
\end{verbatim}


\subsection{Namespaces}
\label{ns}

Child processes such as FastCGI programs can run in separate Linux
namespaces to improve separation from the rest of the server.  That
requires a fairly new Linux kernel.

Articles on \url{http://lwn.net/} on Linux namespaces:

\begin{itemize}
\item \href{https://lwn.net/Articles/531114/}{Namespaces in operation,
  part 1: namespaces overview}
\item \href{http://lwn.net/Articles/531419/}{Namespaces in operation,
  part 3: PID namespaces}
\item \href{http://lwn.net/Articles/532748/}{Namespaces in operation,
  part 4: more on PID namespaces}
\item \href{http://lwn.net/Articles/532593/}{Namespaces in operation,
  part 5: User namespaces}
\item \href{https://lwn.net/Articles/540087/}{Namespaces in operation,
  part 6: more on user namespaces}
\item \href{http://lwn.net/Articles/219794/}{Network namespaces}
\end{itemize}

\subsubsection{User Namespaces}

The translation packet \verb|USER_NAMESPACE| launches the process in a
new user namespace.  This creates a new mapping for user ids inside
this namespace.  More importantly, this gives the process a full set
of capabilities.  This is a precondition for some of the other
namespaces.

Requires Linux 3.8 or newer.

\subsubsection{PID Namespaces}

The translation packet \verb|PID_NAMESPACE| launches the process in a
new PID namespace.  This creates a new mapping for process ids inside
this namespace.  Only processes in this namespace are visible and only
these can be killed.

By default, other processes are actually still visible through
\texttt{/proc}.  For complete PID namespace support, one would need to
mount a new \texttt{proc} filesystem connected to the new namespace.

Requires Linux 3.8 or newer.

\subsubsection{Network Namespaces}

The translation packet \verb|NETWORK_NAMESPACE| launches the process
in a new network namespace.  Without further configuration (not
implemented yet), this leaves the process without access to the
network, because there is no network device in the new namespace.

Depends on user namespaces.  Requires Linux 2.6.29 or newer.

\subsubsection{Mount Namespaces}

A mount namespace makes the VFS mount table private to the new
process.  This namespace is created implicitly by the packets
described in this section.

\verb|PIVOT_ROOT| works like the \texttt{chroot} command; its
payload specifies the directory which will be the new root.  All other
mounts will be removed from the namespace.  The new root must contain
a top-level directory called \texttt{mnt}.  It will be mounted
read-only and with option \texttt{nosuid}.

\verb|MOUNT_PROC| mounts a new read-only instance of the \texttt{proc}
filesystem.

\verb|MOUNT_HOME| bind-mounts the home directory (specified by
\verb|HOME|) to the given directory within the \verb|PIVOT_ROOT|.  It
will be mounted with option \texttt{nosuid}.

\verb|MOUNT_TMP_TMPFS| mounts a new \texttt{tmpfs} on \texttt{/tmp}.
This is private to the namespace and is deleted when the process
exits.

\verb|BIND_MOUNT| mounts arbitrary directories from the old root into
the new root.  The payload is the source directory (absolute path
within the old root) and the target directory (absolute path within
the new root), separated by a null byte.  The new mount will have the
options \texttt{ro,noexec,nosuid,nodev}.

\verb|EXPAND_BIND_MOUNT| is the same as \verb|BIND_MOUNT|, but the
source directory is expanded using \verb|REGEX| results.

\verb|PIVOT_ROOT| depends on user namespaces.  \verb|MOUNT_PROC|,
\verb|MOUNT_HOME| and \verb|MOUNT_TMP_TMPFS| depend on
\verb|PIVOT_ROOT|, user namespaces and PID namespaces.

\subsubsection{UTS Namespaces}

A UTS namespace allows manipulating the host name reported by the
kernel.  \verb|UTS_NAMESPACE| creates the namespace; its payload is
the new host name.

\subsubsection{Namespaces Summary}

The following example describes part of a translation packets that
attempts to execute a child process as securely as possible (without
using JailCGI and Refence):

\begin{verbatim}
USER_NAMESPACE
PID_NAMESPACE
NETWORK_NAMESPACE
PIVOT_ROOT "/var/lib/lxc/wheezy/rootfs"
HOME "/var/www/foo"
MOUNT_HOME "/home/www"
\end{verbatim}

The child process cannot see or kill processes processes other than
the ones that were started by itself.  It cannot access the network.
It lives in another filesystem namespace.  It can access the directory
\texttt{/var/www/foo} at \texttt{/home/www}.  The \texttt{proc}
filesystem is not mounted.

\subsection{Other Child Process Options}

\verb|STDERR_PATH| specifies an absolute path that will be created.
The child's error messages will be appended there.

\subsection{Filters}
\label{filter}

The translation server can tell \emph{beng-proxy} to apply a filter to
the resource by sending the \verb|FILTER| command.  It is followed
by a packet specifying the filter server (\verb|HTTP|,
\verb|CGI|, \verb|FASTCGI|, \verb|AJP|, \verb|PIPE|).

A filter server is a HTTP server.  \emph{beng-proxy} sends the
original resource with a POST request and expects the filtered
resource as response.

It is important that a filter is completely stateless.  Running the
same filter twice on the same source must always render the same
result, at any time.

There may be more than one filter; the order of the \verb|PROCESS|
and \verb|FILTER| packets is important.

According to the HTTP specification, POST requests are not cached.  To
gain the necessary performance, \emph{beng-proxy} caches filter
results, extending the HTTP specification.  This is limited to
resources which have an \emph{ETag} response header, because
\emph{beng-proxy} uses the \emph{ETag} internally to address cache
items.

\subsection{Sessions}
\label{sessions}

\emph{beng-proxy} lets the translation server manage a ``session''
variable, which may be empty, or contain a opaque string.  It is up to
the translation server to manage its contents.  With every translation
request, \emph{beng-proxy} sends its contents unless it is empty (in
which case it omits this parameter).  With every response, the
translation server may provide a new value (which may be empty).

\subsection{\texttt{Content-Type} Lookup}
\label{ctlookup}

The presence of \verb|CONTENT_TYPE_LOOKUP| in a translation response
indicates that the translation server is willing to look up
\texttt{Content-Type} by file name suffix.  It will disable the normal
lookup via \textit{extended attributes}.

When a HTTP request for a static file (local file or NFS file) is
handled, \emph{beng-proxy} will check if the file name has a
``suffix'' (short alphanumeric name after a dot).  If will ask the
translation server for a \texttt{Content-Type} for this suffix.  This
translation request contains the packets \verb|CONTENT_TYPE_LOOKUP|
(echoing the server's packet) and \verb|SUFFIX| (containing the
non-empty suffix without the dot).

Example conversation:

\begin{itemize}
\item client sends \verb|BEGIN| ``\textbackslash{}x03''
\item client sends \verb|CONTENT_TYPE_LOOKUP| ``foo''
\item client sends \verb|SUFFIX| ``png''
\item client sends \verb|END|
\item server sends \verb|BEGIN| ``\textbackslash{}x03''
\item server sends \verb|CONTENT_TYPE| ``image/png''
\item server sends \verb|END|
\end{itemize}

If the suffix is unknown, the translation server may omit the
\verb|CONTENT_TYPE| packet and only reply with \verb|BEGIN| and
\verb|END|.

Additionally, the translation server may specify transformations
(\verb|PROCESS| or \verb|FILTER|) for all files of this type.  They
will be applied before other transformations from the original
translation response.

\subsection{Error documents}
\label{errdoc}

Errors from remote servers are forwarded to the client.  If no error
document is available, \emph{beng-proxy} generates a simple one.

The translation server indicates that it is willing to override the
error document by sending an empty \verb|ERROR_DOCUMENT| packet in
the translation response.  As soon as an error occurs (response status
400..599), \emph{beng-proxy} sends another translation request,
consisting of \verb|ERROR_DOCUMENT|, \verb|URI| and
\verb|STATUS|.  The payload of \verb|ERROR_DOCUMENT| is opaque to
\emph{beng-proxy}, and will be echoed.

The translation server responds with a pointer to another resource
which shall be used as the error document.  If the translation
response is empty, or if the error document itself fails,
\emph{beng-proxy} forwards the original error document (or generates
one).  The error document cannot be filtered or processed.

\subsection{Widget registry}
\label{registry}

The translation server provides access to the widget database, where
all widget servers are registered.  A widget request can use the
following packets:

\begin{longtable}{|l|p{10cm}|}
\hline
\verb|WIDGET_TYPE| & the name of the widget type \\
\hline
\end{longtable}

The translation server's response consists of these packets:

\begin{longtable}{|l|p{8cm}|}
\hline
\verb|STATUS| & in case of a lookup error, this packet provides the
HTTP status code \\
\hline

\verb|PATH|, \verb|CGI|, \verb|HTTP| & choose one of these
packets: a static widget (local file path), a local CGI script, or a
HTTP server \\

\hline

\verb|DOCUMENT_ROOT|, \verb|JAILCGI| & optional flags for CGI
widgets \\

\hline
\verb|PROCESS| & enable the BENG processor \\

\hline

\verb|UNTRUSTED| & sets the externally visible host name for requests
which are proxied to this widget.  This marks the widget as
``untrusted'' and disallows any other way of embedding it.  This is
useful for widget code whose JavaScript must not be executed in the
same context as another widget. \\

\hline

\verb|UNTRUSTED_PREFIX| & same as \verb|UNTRUSTED|, but is a
prefix for the request host name.  This widget can only be used when
the request's \verb|UNTRUSTED| packet begins with this prefix.
Example: \verb|UNTRUSTED_PREFIX="foo"| matches a request with
\verb|UNTRUSTED="foo.example.com"|, but not
\verb|UNTRUSTED="foobar.example.com"|. \\

\hline

\verb|UNTRUSTED_SITE_SUFFIX| & similar to
\verb|UNTRUSTED_PREFIX|, but matches the suffix instead of the
prefix.  When generating untrusted URIs, the site name is prepended.
During verification, the request's \verb|UNTRUSTED| value must
exactly match this scheme. \\

\hline

\verb|DIRECT_ADDRESSING| & Enable ``direct'' URI addressing for this
widget.  It is used when the widget is requested in a ``frame''.  It
is a simpler scheme that is more natural; relative links can be built
without URI rewriting and without the special \emph{beng-proxy}
encoding.  In some cases, the processor can therefore be disabled,
reducing overhead. \\

\hline

\verb|STATEFUL| & remember the state of this widget, i.e. path info
and query string \\

\hline

\verb|WIDGET_INFO| & Send the request headers
\verb|X-CM4all-Widget-Id|, \verb|X-CM4all-Widget-Type| and
\verb|X-CM4all-Widget-Prefix| to the widget server.
\scriptsize{(Since version 1.3.2)}\\

\hline

\label{localuri}
\verb|LOCAL_URI| & The URI of the "local" location of a widget class.
This may refer to a location that serves static resources.  It is used
by the processor for rewriting URIs beginning with ``@/'' (see
\ref{uriat}).  The payload must end with a slash.  \emph{beng-proxy}
does not process this URI.  It is going to be evaluated by the
browser, and may be absolute.  For example, it may refer to a
dedicated resource server. \\

\hline

\verb|DUMP_HEADERS| & Enable header dumps for the widget: on a HTTP
request, the request and response headers will be logged.  Only for
debugging purposes. \\

\hline
\end{longtable}


\subsection{Login translation}
\label{login}

To support interactive login, the translation server can implement
this protocol.  It translates a user name to information on how to
launch the user's processes.

The request contains the following packets:

\begin{longtable}{|l|p{10cm}|}
\hline

\verb|LOGIN| & Marks this request as a ``login'' request.  No
payload. \\

\hline

\verb|SERVICE| & Payload specifies the service that wants to log in,
e.g. "\texttt{ssh}" or "\texttt{ftp}". \\

\hline

\verb|LISTENER_TAG| & A string which specifies the listener this login
was accepted on; this is optional and its configuration is specific to
the translation client. \\

\hline

\verb|USER| & Contains the user name specified by the client. \\

\hline

\verb|PASSWORD| & If this packet is present, then the client asks to
verify a password (clear-text in the payload).  A password mismatch
must result in a negative reply. \\

\hline
\end{longtable}

If the user does not exist, the translation server shall respond with
\texttt{STATUS=404}.

A successful response must contain at least \verb|HOME| and
\verb|UID_GID|:

\begin{longtable}{|l|p{10cm}|}
\hline

\verb|HOME| & Path of the user's home directory. \\

\hline

\verb|UID_GID| & Specify uid and gid (and supplementary groups) for
the child process.  Payload is an array of 32 bit integers. \\

\hline
\end{longtable}

\section{Remote Control Protocol}

\emph{beng-proxy} can listen for multicast packets on a UDP port.
These packets contain one or more commands.  This is useful to notify
a whole cluster of \emph{beng-proxy} servers of an event.

UDP is, by design, a lossy protocol.  One must always consider that
not all nodes may have received a given packet.

The protocol does not implement authentication.  The commands are
designed in a way that they do not affect security.  However, it may
pose a weakness against DoS attacks, if an attacker manages to inject
packets into the internal network.

A command consists of a header containing length and command (network
byte order), and an optional payload.  The payload is padded with null
bytes to the next 4 byte border.

\subsection{Configuring}

The command line option \texttt{--control-listen} allows you to
specify an address to listen on, specify \texttt{*} to listen on all
interfaces.  The default port is 5478.

To enable IP multicast, set the multicast group address with
\texttt{--multicast-group}.

\subsection{Commands}

\begin{longtable}{|l|p{8cm}|}
\hline

\texttt{NOP} & ignored \\

\hline

\verb|TCACHE_INVALIDATE| & Invalidates translation cache entries.
This packet follows the same semantics as the \verb|INVALIDATE|
translation response packet, but instead of passing just a list of
command numbers referring to a real translation request, you need to
send the values as well.  The payload of this packet consists of one
or more concatenated translation packets in network byte order, padded
with zeroes to multiples of 4 bytes.  If the payload is empty, then
the whole translation cache will be flushed. \\

\hline

\verb|ENABLE_NODE| & Re-enable the specified node after a failure,
remove all failure/fade states.  The payload is the node name
according to lb.conf, followed by a colon and the port number. \\

\hline

\verb|FADE_NODE| & Fade out the specified node, preparing for its
shutdown: the server will only be used for pre-existing sessions that
refer to it.  The payload is the node name according to
\texttt{lb.conf}, followed by a colon and the port number.  The effect
lasts for 3 hours. \\

\hline
\end{longtable}


\section{Logging Protocol}

By default, accesses to HTTP resources are logged into the standard
log file (command-line option \texttt{--logger}).  The logging
protocol offers a more flexible alternative: a child process is
launched, connected to \texttt{beng-proxy} with a datagram socket.
Each datagram describes an event to be logged.

\subsection{Launching}

On startup, the logging process has a datagram socket on file
descriptor 0.  On this socket, it receives packets describing the
event.  File descriptor 2 is connected with the local error log, and
can be used to print fatal error messages.

\subsection{Datagram Format}

Each event is serialized into exactly one datagram.  That puts a limit
on the size of an event, and therefore, this protocol is designed to
be small but still easy enough to parse.

A datagram begins with the number 0x63046102 (32 bit), and is followed
by one or more attributes.  The first byte of each attribute is the
attribute id (see \texttt{enum beng\_log\_attribute} in
\texttt{beng-proxy/log.h}).  What follows is specific to the attibute
id.

General rules:

\begin{itemize}
\item there is no padding
\item all numbers are in network byte order (big endian)
\item strings are terminated by a null byte
\end{itemize}

\subsection{Configuring}

The command line option \texttt{--access-logger} receives the command
which launches the child process.  The command is executed with the
shell (\texttt{/bin/sh -c}).

\subsection{Included Loggers}

This section describes the loggers which are included in the Debian
package \texttt{cm4all-beng-proxy-logging}.

\subsubsection{\texttt{log-cat}}

Prints the events to standard output, which will be written to
\texttt{beng-proxy}'s error log file (as if you had not configured a
logger).  It has no arguments.

You can combine it with \texttt{multilog} or similar programs, for
example:

\begin{verbatim}
cm4all-beng-proxy-log-cat |multilog t /var/log/cm4all/access
\end{verbatim}

\subsubsection{\texttt{log-traffic}}

Print site traffic to standard output.  Each line is in the form
``\texttt{SITENAME TRAFFICBYTES}''.

\subsubsection{\texttt{log-split}}

Splits the events into several log files.  The parameters are format
strings which are used to build the file name.  The first valid format
string is used.  Variables in the form \texttt{\%\{name\}} are
substituted; a format string is invalid if an unknown or undefined
variable is referenced.  If no valid format string is valid for an
event, nothing is logged.

Directories are auto-created if they do not exist.

The following variables are available:

\begin{tabular}{|l|p{8cm}|}
\hline
\texttt{date} & the date in the form YYYY-mm-dd \\
\hline
\texttt{year} & the year (4 digits) \\
\hline
\texttt{month} & the month (01..12) \\
\hline
\texttt{day} & the day of month (01..31) \\
\hline
\texttt{hour} & the hour (00..23) \\
\hline
\texttt{minute} & the minute (00..59) \\
\hline
\texttt{site} & the name of the ``site'' \\
\hline
\end{tabular}

Example:

\begin{verbatim}
cm4all-beng-proxy-log-split \
    /var/log/per-site/%{site}/%{date}.log \
    /var/log/unknown-site/%{year}.log
\end{verbatim}

If the first argument is \texttt{--localtime}, then local time is used
instead of GMT.

\subsubsection{\texttt{log-forward}, \texttt{log-exec}}

\texttt{log-forward} forwards the events via UDP to a remote host.
The parameters are the IP addresses of the peers (there may be more
than one).

\begin{verbatim}
cm4all-beng-proxy-log-forward 192.168.1.133
\end{verbatim}

\texttt{log-exec} listens on a UDP port, and launches the real logger
bound to it:

\begin{verbatim}
daemon -o /var/log/access.log \
    cm4all-beng-proxy-log-exec '*' cm4all-beng-proxy-log-cat
\end{verbatim}

The first parameter is the IP address to bind to; ``*'' means listen
on all interfaces.

These two programs are useful in conjunction, to store logs on a
central server.

\subsubsection{\texttt{log-tee}}

\texttt{log-tee} launches multiple child loggers given on the command
line and copies events to all of them.

\begin{verbatim}
cm4all-beng-proxy-log-tee \
  "cm4all-beng-proxy-log-cat |multilog t /var/log/cm4all/access" \
  "cm4all-beng-proxy-log-forward 192.168.1.33"
\end{verbatim}


\section{Widget protocol}

A widget server is simply an HTTP server.  Its content type must be
\texttt{text/html} or \texttt{text/xml}.


\subsection{Hyperlinks}

A widget may provide hyperlinks, e.g. with anchor elements or with
FORM elements.

``Internal links'' are links which are relative to the widget's base
URI - these links can be loaded into the widget's dock.  In CGI, this
feature is called ``PATH\_INFO''.  An internal link may include a
query string.

``External URIs'' are not relative, they should
load in a new browser window.

\subsection{Redirection}

Widgets can send the usual HTTP redirection responses (status
\texttt{3xx}).  The new location must be below the widget's base URI.

\emph{beng-proxy} is currently limited to sending a \texttt{GET}
request following the redirect, because it does not save the request
body.  This is always correct for ``303 See Other'', but may not be
for the other redirection types.  Widget servers should therefore
always redirect with ``303 See Other'' as follow-up to a POST request.

\subsection{Focus}
\label{focus}

To navigate inside a widget, the widget must be ``focused''.  A focus
can be assigned by clicking on a hyperlink that was generated using
the ``focus'' URI rewriting mode (see \ref{c_mode}).

A link pointing to the focused widget may change its current URI
(relative to the widget's base URI).  If the HTTP request contains a
query string or a request body, they are forwarded to that widget,
instead of being sent to the template.

\subsection{POSTing and other methods}

Making the browser send a request body with a POST request is
possible.  It is recommended that you send a ``303 See Other''
redirect as a response to a POST request.  Always reckon that
\emph{beng-proxy} may request a resource multiple times, even without
interaction of the browser.

The same is true for other HTTP methods: \texttt{PUT}, \texttt{DELETE}
and others are passed to the focused widget (see \ref{focus}).

\subsection{Session tracking}

A widget may use HTTP cookies for session tracking, even if the
browser does not support it - \emph{beng-proxy} will take care of it.
The widget should not include some kind of session identification in
the URI.

These cookies are not available in JavaScript.  Besides that, it would
be a bad practice to use cookies in JavaScript which are not actually
evaluated by the server (and cannot be used by the widget server in
this case, since \emph{beng-proxy} does not forward them).  These
cookies would generate a lot of network load for no good, which would
have to go through the visitor's narrow upstream with every request.

It is recommended to use (cookie based) sessions only if really
required.  In many situations, there are more elegant solutions, like
storing the current state of a widget in its current URI (path info).

\subsection{Authentication}
\label{authentication}

\subsubsection{HTTP-level Authentication}

\emph{beng-proxy} supports HTTP-level authentication according to RFC
2617.  It forwards the \texttt{Authorization} request header to the
translation server wrapped in a \verb|AUTHORIZATION| packet, and
allows the translation server to send \texttt{WWW-Authenticate} and
\texttt{Authentication-Info} response headers back to the client,
wrapped in \verb|WWW_AUTHENTICATE| and \verb|AUTHENTICATION_INFO|.

\subsubsection{Application level Authentication}

Authentication is supported in the translation protocol.  After the
translation server sets the \verb|USER| session variable to a
non-empty string, the session is presumed to be authenticated.  This
user variable is passed to widget servers in the proprietary
\texttt{X-CM4all-BENG-User} request header.  The user is logged out
when the translation sends an empty \verb|USER| packet.

\subsubsection{The \texttt{CHECK} packet}

On a protected resource, the translation server may send the
\verb|CHECK| packet together with the normal response.  Now
\texttt{beng-proxy} queries the translation server again, sending the
same request and a copy of the \verb|CHECK| packet.  The translation
server may now verify the current session, redirect to a login page,
or anything else needed to authenticate the user.  The response to
this second translation request may be a resource address as usual, or
the \verb|PREVIOUS| packet, which indicates that the first
translation shall be used.

While the first response is usually cached for a long time, the second
one may specify a short \texttt{MAX\_AGE} value.  This means the latter
is sent more often, but since it refers to the former, it is very
small.

Example 1, unauthenticated user logs in:

\begin{enumerate}
\item \emph{beng-proxy}: \texttt{URI=/protected/foo.html}
\item translation server: \texttt{PATH=/var/www/protected/foo.html
  SESSION=1234 CHECK=xyz}
\item \emph{beng-proxy}: \texttt{URI=/protected/foo.html SESSION=1234
  CHECK=xyz}
\item translation server: \texttt{MAX\_AGE=0 STATUS=403
  CGI=/usr/lib/cgi-bin/login.pl}
\item user enters his credentials, login.pl marks the session
  ``authenticated'', redirects back to the original URI
\item \emph{beng-proxy}: \texttt{URI=/protected/foo.html SESSION=1234
  CHECK=xyz} (from the cached translation response)
\item translation server: \texttt{MAX\_AGE=300 VARY=SESSION PREVIOUS}
\end{enumerate}

Example 2, authenticated user:

\begin{enumerate}
\item \emph{beng-proxy}: \texttt{URI=/protected/foo.html SESSION=2345}
\item translation server: \texttt{PATH=/var/www/protected/foo.html
  CHECK=xyz}
\item \emph{beng-proxy}: \texttt{URI=/protected/foo.html SESSION=2345
  CHECK=xyz}
\item translation server: \texttt{MAX\_AGE=300 VARY=SESSION PREVIOUS}
\end{enumerate}


\subsubsection{The \texttt{AUTH} packet}
\label{auth}

\texttt{AUTH} provides another authentication protocol that was
designed to support SAM and similar authentication services.  If the
client is not already authenticated, the translation server receives a
dedicated authentication request, echoing the \texttt{AUTH} packet.
Additionally, it receives the full request URI in the \texttt{URI}
packet, the ``Host'' header in the \texttt{HOST} packet and the
session id in the \texttt{SESSION} packet.

The response to this \texttt{AUTH} request may be one of the
following:

\begin{itemize}
\item \texttt{USER} specifying the new session user (optionally
  followed by \verb|MAX_AGE|)
\item \texttt{REDIRECT} (optionally with \texttt{STATUS})
\item \texttt{BOUNCE} (optionally with \texttt{STATUS})
\item \texttt{STATUS}
\end{itemize}

Only clients with a fresh \texttt{USER} will be allowed to actually
perform the request.

Caching \texttt{AUTH} requests is not implemented properly; to be
future-proof, the response \textbf{must} begin with \verb|MAX_AGE=0|.
Compatibility will not be guaranteed without it.

Example:

\begin{enumerate}
\item ...
\item translation server: ... \texttt{SESSION=opaque1}
\item \emph{beng-proxy}: \texttt{URI=/foo.html HOST=example.com}
\item translation server: ... \texttt{AUTH=opaque2}
\item \emph{beng-proxy}: \texttt{AUTH=opaque2 SESSION=opaque1 URI=/foo.html;a=b?c=d HOST=example.com}
\item translation server: \texttt{MAX\_AGE=0 USER=hans MAX\_AGE=300}
\end{enumerate}

Note the two \verb|MAX_AGE| packets.  The first one disables caching
for the whole translation response (mandatory, see above) and the
second one enforces revalidation every 5 minutes.

An alternative to \verb|AUTH| is the packet \verb|AUTH_FILE| which
specifies the path to a file containing the \verb|AUTH| payload (no
more than 64 bytes).  This path can be specified dynamically using
\verb|EXPAND_AUTH_FILE|.

Additionally, \verb|APPEND_AUTH| may specify a payload that will be
appended to the contents of the \verb|AUTH_FILE|.  There's also
\verb|EXPAND_APPEND_AUTH|.


\subsection{Referrer}

The \texttt{Referer} request header is not supported.

\subsection{Views}

A widget class may have a number of named views.  Only the ``default''
view has no name, and it cannot be selected explicitly.  A view may
have a different server address, different transformations and other
settings.

A view other than the default one can be selected in three different
ways:

\begin{itemize}
\item in the template with the element \texttt{c:view}
\item as a request argument from the client
\item as a HTTP response header from the widget server
\end{itemize}

For security reasons, the view a client is allowed to choose is
limited.  A view that has an address can only be selected by the
template, to avoid unauthorized access to vulnerable areas.  If the
view chosen by the template enables the HTML processor with the
``container'' flag, \emph{beng-proxy} disallows the client to switch
to another view that is not a ``container'', to avoid exposing the
template's widget parameters (unless the response is not processable).
Switching to a view without an address is always allowed if the
previous view does not make the widget a container.

While the limitations described above do not guarantee real
security, it was decided that it would be an acceptable compromise.

The widget server can select the view with the response header
\texttt{X-CM4all-View}.  Just the list of transformations (processor,
filter) will be used, the new URI of the view will be ignored.  At
this point, a ``partial'' request for a child widget may be discarded
already when the previous view did not declare the widget as a
``container''.  Due to these side effects, this feature should be
avoided if possible; it is better to select the view in the request.

\subsubsection{Generic Views}

Regular HTTP resources can have views, too.  Usually, only the default
view is used.  There is only one way to select a different view: by
using the \texttt{X-CM4all-View} response header.

\section{The Beng Template Language}
\label{processor}

The \emph{beng-proxy} template language defines commands which may be
inserted into XHTML stream.  They are implemented as XML elements and
attributes with the prefix \texttt{c:}.  If you care about validating
the processor input, you must declare the XML namespace \texttt{c:}.
There is currently no suggested namespace URI, and \emph{beng-proxy}
does not actually care, because it does not implement a full-featured
XML parser.

\subsection{Options}

The following translation packets may be used to configure the
processor:

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|PROCESS| & Enables the processor. \\

\hline

\verb|CONTAINER| & Allows embedding other widgets. \\

\hline

\verb|SELF_CONTAINER| & Allows embedding more instances of the current
widget type. \\

\hline

\verb|GROUP_CONTAINER| & Allow this widget to embed instances of this
group.  This can be specified multiple times to allow more than one
group.  It can be combined with \verb|SELF_CONTAINER|. \\

\hline

\verb|WIDGET_GROUP| & Assign a group name to the widget type.  This is
used by \verb|GROUP_CONTAINER|. \\

\hline

\texttt{FOCUS\_WIDGET} & Set the default URI rewriting options to
``base=widget, mode=focus''. \\

\hline

\verb|ANCHOR_ABSOLUTE| & A slash at the beginning or a URI refers to
the widget base, not to the server root. \\

\hline

\verb|PREFIX_CSS_CLASS| & CSS class names with leading underscore
get a widget specific prefix, see \ref{prefix_css_class}. \\

\hline

\verb|PREFIX_XML_ID| & XML ids with leading underscore get a widget
specific prefix, see \ref{prefix_css_class}. \\

\hline

\verb|PROCESS_STYLE| & Shall the processor invoke the CSS processor
for ``style'' element/attribute contents? \\

\hline
\end{longtable}


\subsection{Adding a widget}

To add a widget, use the following command:

\begin{verbatim*}
<c:widget id="foo" type="date" />
\end{verbatim*}

The following attributes may be specified:

\begin{longtable}{|l|p{8cm}|}
\hline
\texttt{id} & unique identification of this widget; this is required
for proper session and form management if there are several widgets
with the same server URI \\
\hline
\texttt{type} & registered name of the widget server \\

\hline

\texttt{display} & specifies how the widget is to be displayed:
\texttt{inline} is the default, and inserts the widget's HTML code
into the current page; \texttt{none} does not display the widget, but
it may be referenced later (see section \ref{frames}) \\

\hline
\texttt{session} & the scope of the widget session (which widgets with
the same id share the same session data?): \texttt{resource} is the
default and means that two documents have different sessions;
\texttt{site} means documents in the same site share session data \\

\hline
\end{longtable}

Registered widgets are not yet implemented.

\subsection{Passing arguments to widgets}

\begin{verbatim*}
<c:widget id="foo" type="date">
  <c:parameter name="timezone" value="PST" />
  <c:path-info value="/bla" />
</c:widget>
\end{verbatim*}

\texttt{parameter} elements adds query string parameters.  These are
added to the query string provided by the browser.  In the value, the
standard XML entities \texttt{amp}, \texttt{quot}, \texttt{apos},
\texttt{lt}, \texttt{gt} are recognized.

There may be one \texttt{path-info} element whose value is appended to
the widget URI, if none was sent by the browser.

This is not a reliable way to transfer bulk data.  Only very short
values should be passed this way to a widget.  There is no guarantee
that \emph{beng-proxy} or other web servers can cope with URIs longer
than 2 kB.  If your widget comes even close, you should reconsider
your approach.

As usual: never trust user input!  The widget server cannot see if
input came from the template or from the user's browser.

\subsection{Passing HTTP headers to widgets}

\begin{verbatim*}
<c:widget id="foo" type="date">
  <c:header name="X-CM4all-Foo" value="Bar" />
</c:widget>
\end{verbatim*}

\texttt{header} elements create HTTP request headers.  Headers are
added, not replaced, i.e. you cannot use this to overwrite existing
headers.  In the header name, only letters, digits and the dash is
allowed.  It must start with ``X-''.

Again: never trust user input!  The widget server cannot see if input
came from the template or from the user's browser.

\subsection{Selecting the widget view}

\begin{verbatim*}
<c:widget id="foo" type="bar">
  <c:view name="raw"/>
</c:widget>
\end{verbatim*}

The \texttt{c:view} element selects the transformation view for this
widget.  It can be one of the view names provided by the widget
registry (i.e. the translation server).

\subsection{Variable substitutions}
\label{entities}

\emph{beng-proxy} defines special entities beginning with \texttt{c:}
for its purposes.  Namespaced entities are not actually allowed in XML
or HTML, and this is only an interim solution until the javascript
filter is finished.  These entities are (unlike normal HTML entities)
also expanded in \texttt{SCRIPT} elements.

\begin{tabular}{|l|p{8cm}|}
\hline

\texttt{\&c:local;} & the ``local'' URI of this widget class (see
\ref{localuri}). \\

\hline

\texttt{\&c:type;} & the class name of this widget \\

\hline

\texttt{\&c:class;} & the quoted class name of this widget \\

\hline

\texttt{\&c:id;} & the id of this widget \\

\hline
\texttt{\&c:path;} & the location of this widget \\
\hline
\texttt{\&c:prefix;} & XML id and Javascript prefix \\
\hline
\texttt{\&c:uri;} & absolute external URI of the current page; use
this variable for redirecting \\
\hline

\texttt{\&c:base;} & base URI of the current page (i.e. without
\emph{beng-proxy} arguments and without the query string) \\

\hline
\texttt{\&c:frame;} & the top widget in this frame (if any) \\
\hline

\texttt{\&c:view;} & the name of the current view \\

\hline
\texttt{\&c:session;} & the current session id \\
\hline
\end{tabular}

\subsection{Relative URIs}
\label{rewrite}

Relative links are difficult with \emph{beng-proxy}, because the
browser interprets links as relative to the document by default.  A
widget author cannot specify a link relative to the widget itself.  To
allow this, \emph{beng-proxy} can rewrite relative links to the
following bases:

\begin{tabular}{|l|p{10cm}|}
\hline

\texttt{template} & links are relative to the main template (default)
\\

\hline

\texttt{widget} & links are relative to the widget; the browser will
leave \emph{beng-proxy} if the user clicks on such a link, because it
points to the widget server \\

\hline

\texttt{child} & link to a child widget; the URI is the ID of the
child widget.  You may append a relative URI separated by a slash. \\

\hline

\texttt{parent} & links are relative to the parent of this widget,
i.e. the container which declared it \\

\hline
\end{tabular}

The base name must be specified in the element attribute
\texttt{c:base} before the attribute containing the URI.  To specify
the mode of the rewritten URI, you may use the attribute
\texttt{c:mode}:

\label{c_mode}
\begin{tabular}{|l|p{10cm}|}
\hline

\texttt{direct} & direct link to the resource \\

\hline

\texttt{focus} & link to \emph{beng-proxy} serving the full page (or
the current frame), focusing the widget (see \ref{focus}) \\

\hline

\texttt{partial} & link to \emph{beng-proxy} serving only the selected
widget; useful for frame contents \\

\hline

\texttt{response} & send a HTTP request to the widget and read the
response body \\

\hline
\end{tabular}

The mode is ignored when the base is ``\texttt{template}''.

The attribute \texttt{c:view} may be used to specify a view name.

\emph{beng-proxy} knows the following HTML elements, and optionally
rewrites URIs:

\begin{itemize}
\item \texttt{A}
\item \texttt{AUDIO}
\item \texttt{EMBED}
\item \texttt{FORM}
\item \texttt{IFRAME}
\item \texttt{IMG}
\item \texttt{SCRIPT}
\item \texttt{VIDEO}
\end{itemize}

Example:

\begin{verbatim*}
<img c:base="widget" c:mode="partial" c:view="raw" src="foo.jpg"/>
\end{verbatim*}

\subsubsection{Processing Instruction syntax}

To set a default value for all following link elements, you may use
the \texttt{<?cm4all-rewrite-uri?>} XML Processing Instruction:

\begin{verbatim*}
<?cm4all-rewrite-uri c:base="widget" c:mode="focus"?>
\end{verbatim*}

This is recommended when many adjacent links share the same URI
rewrite settings, or when you cannot guarantee the order of attributes
(many XSLT processors mix the attribute order, which is allowed).

\subsubsection{Absolute Widget Links}

For widget with many nested levels of ``directories'', it can become
hard to build a absolute links to its resources: a URI with a leading
slash is difficult to do, because that would require the widget code
to know where it was mounted; a relative link is as difficult, because
it requires the widget to be aware of the current nesting level, and
needs extra code.

To do that more easily, the tilde symbol may be used as a URI prefix:
the tilde followed by a slash is considered an absolute link pointing
to the root of the widget.  Example:

Give a widget served from \texttt{http://widget.server/foo/}, the URI
\texttt{\~{}/bar.html} always points to
\texttt{http://widget.server/foo/bar.html}.

This is a proprietary extension in the spirit of the UNIX shell syntax
(referring to the ``home'' of a widget).  It does not work without
\emph{beng-proxy}.

\subsubsection{Static Widget Resources}
\label{uriat}

It is often desirable for widgets to publish static resource files in
a special global location, served without the processor overhead.
This location can be configured with the \verb|LOCAL_URI| translation
packet (see \ref{localuri}).

Within a widget, the URI prefix ``@/'' refers to this location.
Example:

\begin{verbatim}
<img src="@/logo.png"/>
\end{verbatim}

All resources in this location are decoupled from the widget instance
and from the current document.  Therefore, the URI rewriting mode is
ignored.

\subsection{Frames}
\label{frames}

\emph{beng-proxy} supports displaying widgets in an \texttt{IFRAME} or
\texttt{IMG} element.  To do this, declare your widget with
\texttt{display=none}.  After that, insert an \texttt{IFRAME} element
(or any other element which references its content with an URI), and
let \emph{beng-proxy} rewrite the URI:

\begin{verbatim}
<c:widget id="post" type="demo_post" display="none"/>
<iframe width="200" height="200" c:base="child"
  c:mode="partial" src="post"/>
\end{verbatim}

This may be used for any HTML tag which is supported by the
\emph{beng-proxy} URI rewriting code, here an example for a widget
rendering an image:

\begin{verbatim}
<c:widget id="logo" type="logorenderer" display="none"/>
<img c:base="child" c:mode="partial" c:view="raw" src="logo"
  alt="Our website logo"/>
\end{verbatim}

Note that we use \texttt{c:view=raw} here (assuming a view with that
name was defined), because an image should
not (and can not) be processed by \emph{beng-proxy}.  You can also use
\texttt{c:mode=direct} if you want the browser to request the resource
from widget server directly instead of proxying through
\emph{beng-proxy}.

\subsection{Untrusted Widgets}

Usually, widgets are embedded inside the one single HTML page.  The
problem is that all scripts run with the same privileges, and each
widget's scripts can access the whole page, each widget can invoke
requests to any other widget.

As a safeguard against potentially malicious widgets,
\emph{beng-proxy} can run widgets in a separate domain.  The default
security settings of browsers will disallow cross-domain script
access.

To make a widget class ``untrusted'', the translation server generates
the \texttt{HOST} packet with a host name for that widget.  A host
name may be shared by a group of widget classes.

While translating a request, the translation server may send the
\verb|UNTRUSTED| packet, repeating the host name of the request.
This makes the request itself ``untrusted'': trusted widgets are
rejected, and only those untrusted widgets matching the specified host
name are accepted.  If the packet is absend, all untrusted widgets are
rejected.


\section{The Beng JavaScript API}

JavaScript code in a widget frequently needs to send HTTP requests to
the widget server.  All these requests must got through
\emph{beng-proxy}.  Since the structure of a \emph{beng-proxy} URI is
regarded internal, it provides a JavaScript function to generate such
an URI:

\begin{verbatim*}
function
beng_widget_uri(base_uri, session_id, frame, focus, mode,
                path, translate, view);
\end{verbatim*}

The return value is the URI which can be safely requested by the
widget server.  For \texttt{base\_uri}, \texttt{session\_id},
\texttt{frame}, you should pass the value of \texttt{\&c:base;},
\texttt{\&c:session;}, \texttt{\&c:frame;}.

\texttt{focus} is the path of the focused widget, and can be filled
with \texttt{\&c:path;} most of the time, unless you can to request a
different widget than the current one.

\texttt{mode} is one of the following:

\begin{longtable}{|l|p{11cm}|}
\hline

\texttt{focus} & the full page (the default if \texttt{null} is
passed) \\

\hline

\texttt{partial} & just this one widget, processor enabled (must be
\texttt{text/html}) \\

\hline
\end{longtable}

The \texttt{path} argument is an URI relative to the widget.  It may
include a query string.

The \texttt{translate} argument is passed to the translation server as
\texttt{PARAM} packet.

\texttt{view} is the name of the transformation view to use.  This
parameter is ignored unless \texttt{frame} is set, or \texttt{mode} is
``\texttt{partial}''.


\section{The Text Processor}
\label{textprocessor}

The text processor expands the entity references described in
\ref{entities}, but does nothing else.  It may be useful to insert
values into JavaScript files.


\section{The CSS Processor}
\label{cssprocessor}

The CSS processor is a transformation for cascading style sheets.  The
translation server enables it with the packet \verb|PROCESS_CSS|.
It is the equivalent of the HTML processor for CSS: it can convert
URLs to widget resources.  This allows proxying resources that are
referenced in CSS.

The proprietary property \texttt{-c-mode} specifies the URL rewriting
mode for the following URLs in the current block.  See \ref{c_mode}
for a list of valid values.  \texttt{-c-mode} configures a view name.
Example:

\begin{verbatim*}
body {
  -c-mode: partial;
  -c-view: raw;
  background-image:url('background.png');
}
\end{verbatim*}

\subsection{Options}

The following translation packets may be used to configure the
CSS processor:

\begin{longtable}{|l|p{8cm}|}
\hline

\verb|PROCESS_CSS| & Enables the CSS processor. \\

\hline

\verb|PREFIX_CSS_CLASS| & CSS class names with leading underscore
get a widget specific prefix, see below. \\

\hline
\end{longtable}


\subsection{Local Classes}
\label{prefix_css_class}

When the option \verb|PREFIX_CSS_CLASS| is enabled, CSS class
names with a leading underscore are rewritten.  The option is
available in both processors (HTML and CSS).

Two leading underscore makes the class local to the current
widget class.  It may be shared by multiple instances of the same
class.  The two underscores are replaced by the value of
\verb|&c:class;| (see \ref{entities}).

Three leading underscore makes the class local to the current widget
instance.  The three underscores are replaced by the value of
\verb|&c:prefix;| (see \ref{entities}).  Each instance may define
different styles for this class.

The expansion is applied even when the class/id consists only of two
or three underscores.


\section{The prototype translation server}

Until the \texttt{jetserv} daemon is finished, the prototype
translation server should be used.  It is not configurable; this
section describes its hard-coded behaviour.

\subsection{Request translation}

The document root is \texttt{/var/www}.  File names ending with
\texttt{.html} are mapped to the content type ``text/html;
charset=utf-8'' and are marked with the flags \verb|PROCESS|,
\verb|CONTAINER|.

\subsection{Widget registry}

The translation server expects a file for each registered widget type
named \texttt{/etc/cm4all/beng/widgets/TYPENAME}.  Example:

\begin{verbatim*}
server "http://cfatest01.intern.cm-ag/date.py"
process
container
\end{verbatim*}

The first line is mandatory: it specifies the widget server.
\texttt{process} enables the template processor; if that is not
specified, the HTML output is inserted into the resulting page
verbatim.  \texttt{container} allows the widget to embed sub widgets,
\texttt{stateful} sets the ``stateful'' flag.

Disabling features may increase the performance dramatically, because
it allows \emph{beng-proxy} to make better assumptions on data it does
not know yet.  So if you know the widget is a leaf widget, do not
specify \texttt{container}.

Instead of \texttt{server}, you can use \texttt{cgi} to specify the
absolute path of a CGI script which will serve the widget, or
\texttt{path} for a static widget.

For CGI widgets, you can also specify the options
\texttt{script\_name}, \texttt{docu\-ment\_root}, \texttt{action},
\texttt{interpreter} and \texttt{jailcgi}.

\end{document}
