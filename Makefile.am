AUTOMAKE_OPTIONS = foreign 1.10 dist-bzip2 subdir-objects

EXTRA_DIST = \
	doc/beng.tex

#
# Compiler/linker flags
#

LIBEVENT_CFLAGS =
LIBEVENT_LIBS = -levent_core

LIBATTR_CFLAGS =
if HAVE_ATTR_XATTR_H
LIBATTR_LIBS = -lattr
else
LIBATTR_LIBS =
endif

LIBZ_CFLAGS =
LIBZ_LIBS = -lz

AM_CFLAGS += 
AM_CPPFLAGS += \
	$(LIBCM4ALL_DAEMON_CFLAGS) \
	$(LIBCM4ALL_INLINE_CFLAGS) \
	$(LIBCM4ALL_HTTP_CFLAGS) \
	$(LIBCM4ALL_SOCKET_CFLAGS) \
	$(LIBWAS_CFLAGS) \
	$(GLIB_CFLAGS) \
	$(LIBEVENT_CFLAGS) \
	$(LIBATTR_CFLAGS) \
	$(LIBZ_CFLAGS) \
	-DSPLICE \
	-D_GNU_SOURCE
INCLUDES = -I$(srcdir)/src -I$(srcdir)/include
AM_LDADD = \
	-lrt \
	$(GLIB_LIBS) \
	$(LIBEVENT_LIBS)
AM_LDFLAGS = -pthread

if DEFLATE
else
AM_CPPFLAGS += -DNO_DEFLATE
endif

#ifeq ($(ICC),1)
#CC = icc
#AM_CFLAGS = -std=gnu99 -x c -Wall -Werror -wd981
#endif


#
# Source files
#

POOL_SRC = src/pool.c src/pstring.c

ISTREAM_SRC = \
	src/istream-forward.c \
	src/istream-memory.c \
	src/istream-null.c \
	src/istream-zero.c \
	src/istream-block.c \
	src/istream-string.c \
	src/istream-file.c \
	src/istream-chunked.c \
	src/istream-dechunk.c \
	src/istream-fcgi.c \
	src/istream-cat.c \
	src/istream-pipe.c \
	src/istream-delayed.c \
	src/istream-hold.c \
	src/istream-optional.c \
	src/istream-deflate.c \
	src/istream-subst.c \
	src/istream-byte.c \
	src/istream-four.c \
	src/istream-iconv.c \
	src/istream-trace.c \
	src/istream-fail.c \
	src/istream-inject.c \
	src/istream-catch.c \
	src/istream-html-escape.c \
	src/istream-later.c \
	src/istream-head.c \
	src/istream-tee.c \
	src/istream-replace.c \
	src/istream-socketpair.c \
	src/istream-notify.h \
	src/istream-notify.c \
	src/format.c \
	src/fifo-buffer.c \
	src/sink-null.c \
	src/sink-buffer.c \
	src/sink-header.c \
	$(POOL_SRC)

HDR = \
	include/beng-proxy/headers.h \
	include/beng-proxy/translation.h \
	src/abort-close.h \
	src/abort-flag.h \
	src/abort-unref.h \
	src/access-log.h \
	src/address.h \
	src/ajp-client.h \
	src/ajp-headers.h \
	src/ajp-protocol.h \
	src/ajp-read.h \
	src/ajp-request.h \
	src/ajp-serialize.h \
	src/ajp-util.h \
	src/args.h \
	src/async.h \
	src/background.h \
	src/balancer.h \
	src/bot.h \
	src/buffered-io.h \
	src/bulldog.h \
	src/cache.h \
	src/cgi.h \
	src/child.h \
	src/client-socket.h \
	src/config.h \
	src/connection.h \
	src/cookie-client.h \
	src/cookie-server.h \
	src/date.h \
	src/dchunk.h \
	src/defer.h \
	src/delegate-client.h \
	src/delegate-glue.h \
	src/delegate-protocol.h \
	src/delegate-request.h \
	src/delegate-stock.h \
	src/dhashmap.h \
	src/direct.h \
	src/dpool.h \
	src/drop.h \
	src/duplex.h \
	src/embed.h \
	src/event2.h \
	src/expansible-buffer.h \
	src/expiry.h \
	src/failure.h \
	src/fcache.h \
	src/fcgi-client.h \
	src/fcgi-protocol.h \
	src/fcgi-request.h \
	src/fcgi-serialize.h \
	src/fcgi-stock.h \
	src/was-control.h \
	src/was-output.h \
	src/was-input.h \
	src/was-client.h \
	src/was-stock.h \
	src/fd-util.h \
	src/fifo-buffer.h \
	src/file-handler.h \
	src/fork.h \
	src/format.h \
	src/gb-io.h \
	src/get.h \
	src/global.h \
	src/gmtime.h \
	src/growing-buffer.h \
	src/handler.h \
	src/hashmap.h \
	src/header-forward.h \
	src/header-parser.h \
	src/header-writer.h \
	src/hostname.h \
	src/html-chars.h \
	src/html-escape.h \
	src/http-body.h \
	src/http-cache-choice.h \
	src/http-cache-internal.h \
	src/http-cache.h \
	src/http-client.h \
	src/http-error.h \
	src/http-request.h \
	src/http-response.h \
	src/http-server-internal.h \
	src/http-server.h \
	src/http-string.h \
	src/http-util.h \
	src/control-server.h \
	src/control-server.c \
	src/control-handler.h \
	src/control-handler.c \
	src/instance.h \
	src/istream-buffer.h \
	src/istream-forward.h \
	src/istream-impl.h \
	src/istream-internal.h \
	src/istream-invoke.h \
	src/istream-new.h \
	src/istream.h \
	src/jail.h \
	src/lease.h \
	src/listener.h \
	src/lock.h \
	src/memcached-client.h \
	src/memcached-packet.h \
	src/memcached-protocol.h \
	src/memcached-stock.h \
	src/parser.h \
	src/pevent.h \
	src/pipe-stock.h \
	src/pipe.h \
	src/pool.h \
	src/processor.h \
	src/proxy-widget.h \
	src/random.h \
	src/refcount.h \
	src/request-forward.h \
	src/request.h \
	src/resource-address.h \
	src/resource-tag.h \
	src/rewrite-uri.h \
	src/rwlock.h \
	src/serialize.h \
	src/session.h \
	src/shm.h \
	src/sink-gstring.h \
	src/sink-impl.h \
	src/socket-util.h \
	src/static-file.h \
	src/static-headers.h \
	src/stock.h \
	src/stopwatch.h \
	src/strmap.h \
	src/strref-dpool.h \
	src/strref-pool.h \
	src/strref.h \
	src/strref2.h \
	src/strutil.h \
	src/tcache.h \
	src/tcp-stock.h \
	src/tpool.h \
	src/trace.h \
	src/transformation.h \
	src/translate.h \
	src/tstock.h \
	src/udp-listener.h \
	src/udp-distribute.h \
	src/uri-address.h \
	src/uri-edit.h \
	src/uri-escape.h \
	src/uri-extract.h \
	src/uri-parser.h \
	src/uri-relative.h \
	src/uri-resolver.h \
	src/uri-string.h \
	src/uri-verify.h \
	src/uset.h \
	src/widget-http.h \
	src/widget-registry.h \
	src/widget-resolver.h \
	src/widget.h \
	src/worker.h \
	test/libcore-gmtime.h \
	test/t-istream-filter.h

SRC = src/main.c \
	src/clock.h \
	src/cmdline.c \
	src/global.c \
	src/event2.c \
	src/bot.c \
	src/child.c \
	src/defer.c \
	src/worker.c \
	src/shm.c \
	src/dpool.c \
	src/dstring.c \
	src/random.c \
	src/session.c \
	src/cookie-client.c \
	src/cookie-server.c \
	src/connection.c \
	src/drop.c \
	src/direct.c \
	src/jail.c \
	src/translate.c \
	src/transformation.c \
	src/tstock.c \
	src/tcache.c \
	src/request.c \
	src/request-forward.c \
	src/response.c \
	src/rerror.c \
	src/handler.c \
	src/file-handler.c \
	src/proxy-handler.c \
	src/errdoc.c \
	src/ajp-protocol.c \
	src/ajp-serialize.c \
	src/ajp-headers.c \
	src/widget.c \
	src/widget-class.c \
	src/widget-view.c \
	src/widget-ref.c \
	src/widget-session.c \
	src/widget-uri.c \
	src/widget-request.c \
	src/widget-registry.c \
	src/widget-resolver.c \
	src/widget-dump.h \
	src/widget-dump.c \
	src/proxy-widget.c \
	src/html-escape.c \
	src/processor.c \
	src/penv.c \
	src/parser.c \
	src/rewrite-uri.c \
	src/resource-loader.c \
	src/get.c \
	src/static-headers.c \
	src/static-file.c \
	src/widget-http.c \
	src/widget-childc \
	src/inline-widget.c \
	src/frame.c \
	src/fd-util.c \
	src/fd_util.c \
	src/fd_util.h \
	src/socket-util.c \
	src/hostname.c \
	src/address.c \
	src/resource-address.c \
	src/resource-tag.c \
	src/listener.c \
	src/client-socket.c \
	src/udp-listener.c \
	src/udp-distribute.c \
	src/buffered-io.c \
	src/header-parser.c \
	src/header-writer.c \
	src/header-forward.c \
	src/http-string.c \
	src/http-body.c \
	src/http-server.c \
	src/http-server-send.c \
	src/http-server-request.c \
	src/http-server-read.c \
	src/http-server-response.c \
	src/http-client.c \
	src/http-util.c \
	src/istream-ajp-body.c \
	src/istream-gb.h \
	src/istream-gb.c \
	src/ajp-client.c \
	src/access-log.c \
	src/tcp-stock.c \
	src/tcp-balancer.h \
	src/tcp-balancer.c \
	src/http-request.c \
	src/http-error.c \
	src/ajp-request.c \
	src/memcached-client.c \
	src/memcached-packet.c \
	src/memcached-stock.c \
	src/pipe.c \
	src/cgi.c \
	src/fcgi-launch.h \
	src/fcgi-launch.c \
	src/fcgi-stock.c \
	src/fcgi-serialize.c \
	src/fcgi-client.c \
	src/fcgi-request.c \
	src/fcgi-remote.h \
	src/fcgi-remote.c \
	src/was-control.c \
	src/was-output.c \
	src/was-input.c \
	src/was-client.c \
	src/was-launch.c \
	src/was-stock.c \
	src/was-glue.c \
	src/growing-buffer.c \
	src/expansible-buffer.c \
	src/gb-io.c \
	src/serialize.c \
	src/duplex.c \
	$(ISTREAM_SRC) \
	src/fork.c \
	src/delegate-stock.c \
	src/delegate-client.c \
	src/delegate-glue.c \
	src/delegate-request.c \
	src/delegate-handler.c \
	src/address-list.h \
	src/address-list.c \
	src/address-string.h \
	src/address-string.c \
	src/uri-edit.c \
	src/uri-extract.c \
	src/uri-relative.c \
	src/uri-verify.c \
	src/uri-parser.c \
	src/uri-address.c \
	src/uri-resolver.c \
	src/uri-escape.c \
	src/failure.c \
	src/bulldog.c \
	src/balancer.c \
	src/args.c \
	src/gmtime.c \
	src/date.c \
	src/strutil.c \
	src/hashmap.c \
	src/strmap.c \
	src/dhashmap.c \
	src/cache.c \
	src/istream-unlock.c \
	src/http-cache.c \
	src/http-cache-document.c \
	src/http-cache-heap.c \
	src/http-cache-info.c \
	src/http-cache-memcached.c \
	src/http-cache-choice.c \
	src/http-cache-rfc.c \
	src/fcache.c \
	src/stock.c \
	src/hstock.c \
	src/pipe-stock.c \
	src/abort-close.c \
	src/abort-unref.c \
	src/abort-flag.c \
	src/tpool.c \
	src/log-client.c src/log-client.h \
	src/log-launch.c src/log-launch.h \
	src/log-glue.c src/log-glue.h \
	$(HDR)

if ENABLE_STOPWATCH
SRC += src/stopwatch.c src/istream-stopwatch.c
endif

#
# Programs
#

bin_PROGRAMS = src/cm4all-beng-proxy \
	src/cm4all-beng-lb \
	src/cm4all-beng-proxy-log-cat \
	src/cm4all-beng-proxy-log-traffic \
	src/cm4all-beng-proxy-log-split \
	src/cm4all-beng-proxy-log-forward \
	src/cm4all-beng-proxy-log-exec \
	src/cm4all-beng-proxy-delegate-helper

src_cm4all_beng_lb_SOURCES = \
	src/pool.c \
	src/pstring.c \
	src/format.c \
	src/date.c \
	src/gmtime.c \
	src/strutil.c \
	src/istream-null.c \
	src/istream-chunked.c \
	src/istream-dechunk.c \
	src/istream-memory.c \
	src/istream-string.c \
	src/istream-cat.c \
	src/istream-optional.c \
	src/istream-forward.c \
	src/tpool.c \
	src/stock.c \
	src/hstock.c \
	src/tcp-stock.c \
	src/tcp-balancer.c \
	src/pipe-stock.c \
	src/failure.c \
	src/balancer.c \
	src/address.c \
	src/address-list.c \
	src/address-string.h \
	src/address-string.c \
	src/address-edit.h \
	src/address-edit.c \
	src/listener.c \
	src/client-socket.c \
	src/bulldog.c \
	src/child.c \
	src/hashmap.c \
	src/strmap.c \
	src/cache.c \
	src/http-body.c \
	src/http-server.c \
	src/http-server-send.c \
	src/http-server-request.c \
	src/http-server-read.c \
	src/http-server-response.c \
	src/http-client.c \
	src/http-string.c \
	src/header-writer.c \
	src/header-parser.c \
	src/uri-verify.c \
	src/uri-resolver.c \
	src/uri-address.c \
	src/uri-edit.c \
	src/fifo-buffer.c \
	src/growing-buffer.c \
	src/istream-gb.c \
	src/buffered-io.c \
	src/event2.c \
	src/fd_util.c \
	src/fd-util.c \
	src/stopwatch.c \
	src/direct.c \
	src/access-log.c \
	src/cookie-server.c \
	src/log-glue.c \
	src/log-client.c \
	src/log-launch.c \
	src/lb_global.c \
	src/lb_cmdline.h \
	src/lb_cmdline.c \
	src/lb_listener.h \
	src/lb_listener.c \
	src/lb_connection.h \
	src/lb_connection.c \
	src/lb_http.h \
	src/lb_http.c \
	src/lb_session.h \
	src/lb_session.c \
	src/lb_config.h \
	src/lb_config.c \
	src/lb_setup.h \
	src/lb_setup.c \
	src/lb_main.c
src_cm4all_beng_lb_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_INLINE_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBEVENT_LIBS)
src_cm4all_beng_lb_LDFLAGS = $(AM_LDFLAGS)

src_cm4all_beng_proxy_SOURCES = $(SRC)
src_cm4all_beng_proxy_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_INLINE_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBEVENT_LIBS) \
	$(LIBATTR_LIBS) \
	$(LIBZ_LIBS)
src_cm4all_beng_proxy_LDFLAGS = $(AM_LDFLAGS)

if GPROF
AM_CFLAGS += -pg
AM_CPPFLAGS += -DPROFILE
src_cm4all_beng_proxy_LDADD += -lc_p
src_cm4all_beng_proxy_LDFLAGS += -pg
endif

src_cm4all_beng_proxy_log_cat_SOURCES = \
	src/log-server.c \
	src/log-cat.c
src_cm4all_beng_proxy_log_cat_LDADD = \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(GLIB_LIBS)

src_cm4all_beng_proxy_log_traffic_SOURCES = \
	src/log-server.c \
	src/log-traffic.c
src_cm4all_beng_proxy_log_traffic_LDADD = \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(GLIB_LIBS)

src_cm4all_beng_proxy_log_split_SOURCES = \
	src/log-server.c \
	src/log-split.c
src_cm4all_beng_proxy_log_split_LDADD = \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(GLIB_LIBS)

src_cm4all_beng_proxy_log_forward_SOURCES = \
	src/fd_util.c \
	src/log-forward.c
src_cm4all_beng_proxy_log_forward_LDADD = \
	$(LIBCM4ALL_SOCKET_LIBS)

src_cm4all_beng_proxy_log_exec_SOURCES = \
	src/log-exec.c
src_cm4all_beng_proxy_log_exec_LDADD = \
	$(LIBCM4ALL_SOCKET_LIBS)

src_cm4all_beng_proxy_delegate_helper_SOURCES = src/delegate-helper.c

#
# Libraries
#

lib_LIBRARIES = src/libcm4all-istream.a
src_libcm4all_istream_a_SOURCES = $(ISTREAM_SRC)

pkginclude_HEADERS = \
	src/istream-buffer.h \
	src/istream-forward.h \
	src/istream-impl.h \
	src/istream-internal.h \
	src/istream-invoke.h \
	src/istream-new.h \
	src/istream.h \
	include/beng-proxy/headers.h \
	include/beng-proxy/translation.h

pkgconfigdir = $(libdir)/pkgconfig
pkgconfig_DATA = libcm4all-beng-proxy.pc libcm4all-istream.pc


#
# Test suite
#

if TEST

FILTER_TESTS = test/t-istream-cat test/t-istream-chunked test/t-istream-dechunk \
	test/t-istream-pipe test/t-istream-hold test/t-istream-delayed \
	test/t-istream-subst test/t-istream-deflate test/t-istream-byte \
	test/t-istream-iconv test/t-istream-replace test/t-istream-replace2 \
	test/t-istream-html-escape test/t-istream-fcgi \
	test/t-sink-header \
	test/t-sink-header-empty \
	test/t-istream-processor

check_PROGRAMS = \
	test/run-was \
	test/was-mirror \
	test/t-hashmap test/t-cache test/t-tcache \
	test/t-header-forward \
	test/t-stock \
	test/t-resource-address \
	test/t-uri-relative \
	test/t-html-escape \
	test/t-expansible-buffer \
	$(FILTER_TESTS) \
	test/t-istream-tee \
	test/t-growing-buffer \
	test/t-cgi \
	test/t-http-server-mirror test/t-http-server-null \
	test/t-http-server-dummy \
	test/t-http-server-fixed \
	test/t-http-server \
	test/t-http-client test/t-http-util \
	test/t-http-cache \
	test/t-cookie-client \
	test/t-cookie-server \
	test/t-shm test/t-dpool test/t-session \
	test/t-rewrite-uri \
	test/t-widget-registry \
	test/t-wembed test/t-widget-http \
	test/benchmark-gmtime test/format-http-date \
	test/request-translation \
	test/run-subst \
	test/run-cookie-client \
	test/run-cookie-server \
	test/run-header-parser \
	test/run-html-unescape test/run-html-escape \
	test/run-processor \
	test/t-processor \
	test/run-ajp-client \
	test/run-memcached-client \
	test/dump-memcached-choice \
	test/cleanup-memcached-choice \
	test/fake-memcached-server \
	test/t-memcached-client \
	test/run-delegate \
	test/dump-udp test/dump-control test/send-control \
	test/run-parser-cdata

TESTS = test/t-hashmap test/t-cache test/t-tcache \
	test/t-header-forward \
	test/t-stock \
	test/t-resource-address \
	test/t-uri-relative \
	test/t-html-escape \
	test/t-expansible-buffer \
	$(FILTER_TESTS) \
	test/t-istream-tee \
	test/t-growing-buffer \
	test/t-cgi \
	$(srcdir)/test/t-http-server.py test/t-http-server \
	test/t-http-client test/t-http-util \
	test/t-http-cache \
	test/t-processor \
	test/t-memcached-client \
	$(srcdir)/test/t-cookie-client.py test/t-cookie-client \
	test/t-cookie-server \
	test/t-shm test/t-dpool test/t-session \
	test/t-rewrite-uri \
	test/t-widget-registry \
	test/t-wembed test/t-widget-http

test_run_was_SOURCES = test/run-was.c \
	src/was-launch.c src/was-client.c src/was-control.c src/was-input.c src/was-output.c \
	src/jail.c \
	src/strmap.c src/hashmap.c \
	src/fifo-buffer.c src/buffered-io.c \
	src/direct.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/istream-file.c \
	$(POOL_SRC)
test_run_was_LDADD = $(LIBEVENT_LIBS) $(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(GLIB_LIBS)

test_was_mirror_SOURCES = test/was-mirror.c \
	src/was-server.c src/was-control.c src/was-input.c src/was-output.c \
	src/fifo-buffer.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/istream-forward.c src/istream-string.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/direct.c \
	src/fd_util.c src/fd-util.c src/socket-util.c
test_was_mirror_LDADD = $(LIBEVENT_LIBS) $(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(GLIB_LIBS)

test_t_hashmap_SOURCES = test/t-hashmap.c src/hashmap.c $(POOL_SRC)
test_t_hashmap_LDADD = $(LIBCM4ALL_DAEMON_LIBS)

test_t_cache_SOURCES = test/t-cache.c src/cache.c src/hashmap.c $(POOL_SRC)
test_t_cache_LDADD = $(LIBCM4ALL_DAEMON_LIBS) $(LIBEVENT_LIBS)

test_t_tcache_SOURCES = test/t-tcache.c src/tcache.c src/cache.c \
	src/hashmap.c src/strmap.c \
	src/resource-address.c src/uri-address.c \
	src/widget-view.c \
	src/jail.c \
	src/uri-relative.c src/uri-edit.c src/uri-verify.c src/uri-escape.c \
	src/address-list.c \
	src/format.c \
	src/transformation.c \
	$(POOL_SRC)
test_t_tcache_LDADD = $(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBEVENT_LIBS) $(GLIB_LIBS) -lrt

test_t_header_forward_SOURCES = test/t-header-forward.c \
	src/header-forward.c src/header-writer.c \
	src/http-string.c \
	src/hashmap.c src/strmap.c \
	src/growing-buffer.c \
	src/cookie-client.c \
	src/shm.c src/dpool.c src/dstring.c src/dhashmap.c \
	src/random.c src/socket-util.c src/fd-util.c \
	src/fd_util.c \
	src/session.c src/format.c \
	src/tpool.c $(POOL_SRC)
test_t_header_forward_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS)

test_t_stock_SOURCES = test/t-stock.c src/stock.c $(POOL_SRC)
test_t_stock_LDADD = $(LIBCM4ALL_DAEMON_LIBS) $(LIBEVENT_LIBS) $(GLIB_LIBS)

test_t_resource_address_SOURCES = test/t-resource-address.c \
	src/resource-address.c \
	src/jail.c \
	src/uri-address.c src/uri-relative.c src/uri-verify.c \
	src/uri-escape.c src/uri-edit.c \
	src/address-list.c \
	src/format.c \
	$(POOL_SRC)
test_t_resource_address_LDADD = $(LIBCM4ALL_DAEMON_LIBS) $(LIBCM4ALL_SOCKET_LIBS)

test_t_uri_relative_SOURCES = test/t-uri-relative.c \
	src/uri-relative.c \
	$(POOL_SRC)
test_t_uri_relative_LDADD = $(LIBCM4ALL_DAEMON_LIBS)

test_t_expansible_buffer_SOURCES = test/t-expansible-buffer.c \
	src/expansible-buffer.c \
	$(POOL_SRC)
test_t_expansible_buffer_LDADD = $(LIBCM4ALL_DAEMON_LIBS)

T_ISTREAM_FILTER_SRC = $(ISTREAM_SRC) \
	src/direct.c \
	src/buffered-io.c src/event2.c \
	src/pipe-stock.c src/stock.c \
	src/fd_util.c \
	src/growing-buffer.c src/fd-util.c src/socket-util.c
T_ISTREAM_FILTER_LIB = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS) $(LIBEVENT_LIBS) $(LIBZ_LIBS)

test_t_istream_cat_SOURCES = test/t-istream-cat.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_cat_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_chunked_SOURCES = test/t-istream-chunked.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_chunked_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_dechunk_SOURCES = test/t-istream-dechunk.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_dechunk_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_pipe_SOURCES = test/t-istream-pipe.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_pipe_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_hold_SOURCES = test/t-istream-hold.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_hold_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_delayed_SOURCES = test/t-istream-delayed.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_delayed_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_subst_SOURCES = test/t-istream-subst.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_subst_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_deflate_SOURCES = test/t-istream-deflate.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_deflate_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_byte_SOURCES = test/t-istream-byte.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_byte_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_iconv_SOURCES = test/t-istream-iconv.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_iconv_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_replace_SOURCES = test/t-istream-replace.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_replace_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_replace2_SOURCES = test/t-istream-replace2.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_replace2_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_html_escape_SOURCES = test/t-istream-html-escape.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_html_escape_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_fcgi_SOURCES = test/t-istream-cat.c $(T_ISTREAM_FILTER_SRC)
test_t_istream_fcgi_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_processor_SOURCES = test/t-istream-processor.c \
	src/uri-relative.c src/uri-parser.c src/uri-escape.c src/uri-edit.c \
	src/uri-verify.c \
	src/random.c \
	src/session.c src/cookie-client.c \
	src/http-string.c \
	src/strmap.c src/hashmap.c \
	src/penv.c src/processor.c \
	src/html-escape.c \
	src/widget-request.c \
	src/widget.c src/widget-ref.c src/widget-uri.c src/args.c \
	src/widget-session.c src/parser.c src/widget-class.c \
	src/widget-view.c \
	src/tpool.c src/rewrite-uri.c src/widget-resolver.c \
	src/uri-address.c src/uri-extract.c \
	src/address-list.c \
	src/dhashmap.c src/dpool.c src/shm.c src/dstring.c \
	src/resource-address.c src/global.c src/transformation.c \
	src/jail.c \
	src/expansible-buffer.c \
	$(T_ISTREAM_FILTER_SRC)
test_t_istream_processor_LDADD = $(AM_LDADD) \
	$(T_ISTREAM_FILTER_LIB) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_sink_header_SOURCES = test/t-sink-header.c \
	$(T_ISTREAM_FILTER_SRC)
test_t_sink_header_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_sink_header_empty_SOURCES = test/t-sink-header-empty.c \
	$(T_ISTREAM_FILTER_SRC)
test_t_sink_header_empty_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_istream_tee_SOURCES = test/t-istream-tee.c \
	src/sink-gstring.c \
	src/sink-close.c \
	$(T_ISTREAM_FILTER_SRC)
test_t_istream_tee_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_growing_buffer_SOURCES = test/t-growing-buffer.c \
	src/istream-gb.c \
	$(T_ISTREAM_FILTER_SRC)
test_t_growing_buffer_LDADD = $(T_ISTREAM_FILTER_LIB)

test_t_cgi_SOURCES = test/t-cgi.c \
	src/cgi.c src/fork.c \
	$(POOL_SRC) src/tpool.c \
	src/fifo-buffer.c src/buffered-io.c src/growing-buffer.c \
	src/header-parser.c \
	src/strmap.c src/hashmap.c \
	src/event2.c \
	src/fd_util.c src/socket-util.c src/fd-util.c \
	src/child.c \
	src/strutil.c \
	src/stopwatch.c \
	src/istream-file.c src/abort-flag.c src/direct.c
test_t_cgi_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) $(LIBCM4ALL_SOCKET_LIBS)

test_t_http_server_SOURCES = test/t-http-server.c \
	src/http-server.c src/http-server-send.c src/http-server-request.c \
	src/http-server-read.c src/http-server-response.c \
	src/address.c \
	src/fifo-buffer.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-dechunk.c \
	src/istream-chunked.c src/istream-pipe.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/pipe-stock.c src/stock.c \
	src/direct.c \
	src/http-body.c src/date.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/growing-buffer.c \
	src/header-parser.c src/format.c \
	src/strutil.c \
	src/gmtime.c \
	src/tpool.c \
	src/istream-socketpair.c src/istream-block.c src/istream-catch.c \
	src/sink-null.c src/event2.c
test_t_http_server_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_server_mirror_SOURCES = test/t-http-server-mirror.c \
	src/http-server.c src/http-server-send.c src/http-server-request.c \
	src/http-server-read.c src/http-server-response.c \
	src/address.c \
	src/fifo-buffer.c \
	src/duplex.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-dechunk.c \
	src/istream-chunked.c src/istream-pipe.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/pipe-stock.c src/stock.c \
	src/direct.c \
	src/http-body.c src/date.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/growing-buffer.c \
	src/header-parser.c src/format.c \
	src/strutil.c src/gmtime.c src/tpool.c src/event2.c
test_t_http_server_mirror_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_server_null_SOURCES = test/t-http-server-null.c \
	src/http-server.c src/http-server-send.c src/http-server-request.c \
	src/http-server-read.c src/http-server-response.c \
	src/address.c \
	src/fifo-buffer.c \
	src/duplex.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-dechunk.c \
	src/istream-chunked.c src/istream-pipe.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/sink-null.c \
	src/pipe-stock.c src/stock.c \
	src/direct.c \
	src/http-body.c src/date.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/growing-buffer.c \
	src/header-parser.c src/format.c \
	src/strutil.c src/gmtime.c src/tpool.c src/event2.c
test_t_http_server_null_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_server_dummy_SOURCES = test/t-http-server-dummy.c \
	src/http-server.c src/http-server-send.c src/http-server-request.c \
	src/http-server-read.c src/http-server-response.c \
	src/address.c \
	src/fifo-buffer.c \
	src/duplex.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-dechunk.c \
	src/istream-chunked.c src/istream-pipe.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/istream-head.c src/istream-zero.c src/istream-byte.c \
	src/sink-null.c \
	src/pipe-stock.c src/stock.c \
	src/direct.c \
	src/http-body.c src/date.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/growing-buffer.c \
	src/header-parser.c src/format.c \
	src/strutil.c src/gmtime.c src/tpool.c src/event2.c
test_t_http_server_dummy_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_server_fixed_SOURCES = test/t-http-server-fixed.c \
	src/http-server.c src/http-server-send.c src/http-server-request.c \
	src/http-server-read.c src/http-server-response.c \
	src/address.c \
	src/fifo-buffer.c \
	src/duplex.c \
	$(POOL_SRC) \
	src/buffered-io.c \
	src/strmap.c src/hashmap.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-dechunk.c \
	src/istream-chunked.c src/istream-pipe.c src/istream-memory.c \
	src/istream-cat.c src/istream-null.c \
	src/sink-null.c \
	src/pipe-stock.c src/stock.c \
	src/direct.c \
	src/http-body.c src/date.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/growing-buffer.c \
	src/header-parser.c src/format.c \
	src/strutil.c src/gmtime.c src/tpool.c src/event2.c
test_t_http_server_fixed_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_client_SOURCES = test/t-http-client.c \
	src/http-client.c \
	$(POOL_SRC) \
	src/strmap.c src/hashmap.c \
	src/growing-buffer.c src/fifo-buffer.c \
	src/header-writer.c \
	src/istream-gb.c \
	src/istream-forward.c src/istream-string.c src/istream-memory.c \
	src/istream-cat.c src/istream-fail.c src/istream-block.c \
	src/istream-chunked.c src/istream-dechunk.c \
	src/istream-head.c src/istream-null.c src/istream-zero.c \
	src/istream-delayed.c src/istream-optional.c \
	src/istream-byte.c \
	src/direct.c \
	src/http-body.c src/header-parser.c \
	src/format.c src/strutil.c \
	src/buffered-io.c src/fd_util.c src/fd-util.c src/socket-util.c \
	src/uri-verify.c \
	src/stopwatch.c \
	src/tpool.c src/event2.c
test_t_http_client_LDADD = $(AM_LDADD) \
	$(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_http_util_SOURCES = test/t-http-util.c \
	$(POOL_SRC) \
	src/http-util.c src/strutil.c
test_t_http_util_LDADD = $(LIBCM4ALL_DAEMON_LIBS)

test_t_http_cache_SOURCES = test/t-http-cache.c \
	$(POOL_SRC) src/tpool.c \
	src/strmap.c src/hashmap.c \
	src/fifo-buffer.c src/header-parser.c \
	src/growing-buffer.c \
	src/strutil.c \
	src/istream-gb.c \
	src/istream-memory.c src/istream-string.c \
	src/http-cache.c src/http-cache-rfc.c \
	src/http-cache-info.c src/http-cache-document.c \
	src/http-cache-heap.c \
	src/resource-address.c src/uri-address.c \
	src/jail.c \
	src/uri-edit.c src/uri-relative.c src/uri-escape.c src/uri-verify.c \
	src/address-list.c \
	src/format.c \
	src/abort-unref.c src/cache.c \
	src/header-writer.c src/http-util.c \
	src/istream-tee.c src/istream-hold.c \
	src/date.c src/gmtime.c \
	src/istream-null.c src/istream-unlock.c src/istream-forward.c
test_t_http_cache_LDADD = $(LIBCM4ALL_DAEMON_LIBS) $(LIBEVENT_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(GLIB_LIBS)

test_t_cookie_client_SOURCES = test/t-cookie-client.c \
	$(POOL_SRC) src/tpool.c \
	src/cookie-client.c \
	src/http-string.c \
	src/header-writer.c src/growing-buffer.c \
	src/strmap.c src/hashmap.c \
	src/shm.c src/dpool.c src/dstring.c
test_t_cookie_client_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS)

test_t_cookie_server_SOURCES = test/t-cookie-server.c \
	$(POOL_SRC) \
	src/cookie-server.c \
	src/http-string.c \
	src/strmap.c src/hashmap.c
test_t_cookie_server_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_t_shm_SOURCES = test/t-shm.c src/shm.c
test_t_shm_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_t_dpool_SOURCES = test/t-dpool.c src/shm.c src/dpool.c
test_t_dpool_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_t_session_SOURCES = test/t-session.c src/shm.c \
	src/dpool.c src/dstring.c src/dhashmap.c \
	src/format.c \
	src/random.c src/socket-util.c src/fd-util.c src/fd_util.c \
	src/session.c
test_t_session_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_t_rewrite_uri_SOURCES = test/t-rewrite-uri.c \
	$(POOL_SRC) src/tpool.c \
	src/rewrite-uri.c src/widget-uri.c src/widget.c \
	src/widget-view.c src/transformation.c \
	src/istream-null.c src/istream-delayed.c src/istream-memory.c \
	src/istream-forward.c src/istream-string.c \
	src/sink-gstring.c \
	src/args.c \
	src/strmap.c src/hashmap.c \
	src/resource-address.c src/uri-address.c \
	src/address-list.c \
	src/jail.c \
	src/uri-relative.c src/uri-edit.c src/uri-escape.c src/uri-parser.c \
	src/uri-verify.c src/uri-extract.c \
	src/html-escape.c src/istream-html-escape.c \
	src/format.c
test_t_rewrite_uri_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_widget_registry_SOURCES = test/t-widget-registry.c \
	src/widget-registry.c src/stock.c \
	$(POOL_SRC) \
	src/uri-address.c src/transformation.c \
	src/address-list.c \
	src/tcache.c src/cache.c \
	src/widget-view.c \
	src/hashmap.c src/strmap.c src/abort-unref.c \
	src/resource-address.c \
	src/jail.c \
	src/uri-relative.c src/uri-verify.c src/uri-escape.c src/uri-edit.c \
	src/format.c
test_t_widget_registry_LDADD = $(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBEVENT_LIBS) $(GLIB_LIBS)

test_t_wembed_SOURCES = test/t-wembed.c \
	src/inline-widget.c \
	$(POOL_SRC) \
	src/istream-delayed.c src/istream-hold.c src/istream-forward.c \
	src/istream-null.c src/istream-iconv.c \
	src/istream-string.c src/istream-memory.c \
	src/istream-cat.c src/istream-html-escape.c \
	src/fifo-buffer.c \
	src/hashmap.c src/strmap.c \
	src/http-util.c src/strutil.c \
	src/uri-parser.c src/uri-escape.c src/uri-verify.c \
	src/format.c src/global.c
test_t_wembed_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(GLIB_LIBS)

test_t_widget_http_SOURCES = test/t-widget-http.c \
	src/widget-http.c src/widget-uri.c src/widget-request.c \
	src/widget-session.c src/session.c \
	src/widget-view.c src/widget.c \
	src/random.c src/socket-util.c src/fd-util.c \
	src/fd_util.c \
	src/args.c src/uri-escape.c src/uri-verify.c \
	src/format.c \
	src/resource-address.c src/uri-address.c \
	src/address-list.c \
	src/jail.c \
	src/uri-relative.c src/uri-edit.c src/uri-extract.c \
	src/resource-tag.c \
	src/cookie-client.c \
	src/header-parser.c src/header-forward.c src/header-writer.c \
	src/strmap.c src/hashmap.c \
	src/growing-buffer.c src/fifo-buffer.c \
	src/strutil.c src/http-string.c src/http-util.c \
	src/istream-string.c src/istream-iconv.c src/istream-html-escape.c \
	src/istream-cat.c src/istream-forward.c src/istream-memory.c \
	src/istream-null.c \
	src/transformation.c \
	src/dpool.c src/dstring.c src/dhashmap.c src/shm.c \
	$(POOL_SRC) src/tpool.c
test_t_widget_http_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_benchmark_gmtime_SOURCES = test/benchmark-gmtime.c \
	src/gmtime.c test/libcore-gmtime.c

test_format_http_date_SOURCES = test/format-http-date.c \
	src/gmtime.c src/date.c

test_request_translation_SOURCES = test/request-translation.c \
	src/translate.c src/tstock.c src/growing-buffer.c src/gb-io.c \
	src/failure.c src/bulldog.c src/balancer.c src/cache.c \
	src/tcp-stock.c src/client-socket.c \
	src/fd_util.c src/fd-util.c src/socket-util.c \
	src/stock.c src/hstock.c src/hashmap.c src/strmap.c \
	src/strutil.c \
	src/abort-unref.c \
	src/uri-address.c src/uri-edit.c \
	src/uri-escape.c src/uri-relative.c src/uri-verify.c \
	src/address-list.c \
	src/format.c \
	src/stopwatch.c \
	src/widget-view.c \
	src/resource-address.c src/transformation.c src/jail.c \
	$(POOL_SRC)
test_request_translation_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_run_subst_SOURCES = test/run-subst.c \
	src/istream-subst.c src/istream-file.c \
	src/fifo-buffer.c src/buffered-io.c \
	src/fd_util.c \
	$(POOL_SRC)
test_run_subst_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_run_cookie_client_SOURCES = test/run-cookie-client.c \
	src/cookie-client.c src/http-string.c \
	src/header-writer.c src/growing-buffer.c \
	src/tpool.c src/strmap.c src/hashmap.c \
	src/shm.c src/dpool.c src/dstring.c \
	$(POOL_SRC)
test_run_cookie_client_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS)

test_run_cookie_server_SOURCES = test/run-cookie-server.c \
	src/cookie-server.c src/http-string.c \
	src/strmap.c src/hashmap.c \
	$(POOL_SRC)
test_run_cookie_server_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_run_header_parser_SOURCES = test/run-header-parser.c \
	src/header-parser.c src/growing-buffer.c src/fifo-buffer.c \
	src/tpool.c src/strmap.c src/strutil.c \
	src/hashmap.c \
	$(POOL_SRC)
test_run_header_parser_LDADD = $(LIBCM4ALL_DAEMON_LIBS)

test_run_html_unescape_SOURCES = test/run-html-unescape.c src/html-escape.c
test_run_html_escape_SOURCES = test/run-html-escape.c src/html-escape.c

test_t_html_escape_SOURCES = test/t-html-escape.c src/html-escape.c

test_run_processor_SOURCES = test/run-processor.c \
	src/processor.c src/penv.c src/parser.c \
	src/html-escape.c \
	src/istream-replace.c \
	src/widget.c src/widget-ref.c \
	src/uri-relative.c src/uri-edit.c src/uri-extract.c \
	src/uri-parser.c src/uri-escape.c src/uri-verify.c \
	src/strmap.c src/hashmap.c \
	src/growing-buffer.c src/fifo-buffer.c \
	src/tpool.c \
	src/istream-string.c src/istream-subst.c src/istream-file.c \
	src/istream-cat.c src/istream-memory.c \
	src/istream-hold.c src/istream-dechunk.c src/istream-chunked.c \
	src/header-writer.c src/args.c src/buffered-io.c \
	src/tcp-stock.c src/stock.c src/hstock.c \
	src/client-socket.c src/fd_util.c \
	src/format.c src/header-parser.c src/strutil.c \
	src/widget-request.c \
	src/widget-view.c \
	src/resource-address.c src/jail.c src/transformation.c \
	src/istream-tee.c src/istream-null.c \
	src/event2.c src/failure.c src/bulldog.c \
	src/balancer.c src/uri-address.c src/cache.c \
	src/address-list.c \
	src/shm.c src/dpool.c src/dstring.c src/dhashmap.c \
	src/expansible-buffer.c \
	src/istream-forward.c src/istream-catch.c \
	src/stopwatch.c \
	$(POOL_SRC)
test_run_processor_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_t_processor_SOURCES = test/t-processor.c \
	src/processor.c src/penv.c src/parser.c \
	src/html-escape.c \
	src/istream-replace.c \
	src/widget.c src/widget-ref.c \
	src/uri-relative.c src/uri-edit.c \
	src/uri-parser.c src/uri-escape.c src/uri-verify.c \
	src/strmap.c src/hashmap.c \
	src/growing-buffer.c src/fifo-buffer.c \
	src/tpool.c \
	src/istream-string.c src/istream-subst.c src/istream-block.c \
	src/istream-cat.c src/istream-memory.c src/istream-delayed.c \
	src/istream-hold.c src/istream-dechunk.c src/istream-chunked.c \
	src/header-writer.c src/args.c src/buffered-io.c \
	src/tcp-stock.c src/stock.c src/hstock.c \
	src/client-socket.c src/fd_util.c \
	src/format.c src/header-parser.c src/strutil.c \
	src/widget-request.c \
	src/widget-view.c \
	src/resource-address.c src/jail.c src/transformation.c \
	src/istream-tee.c src/istream-null.c \
	src/event2.c src/failure.c src/bulldog.c \
	src/balancer.c src/uri-address.c src/cache.c \
	src/address-list.c \
	src/shm.c src/dpool.c src/dstring.c src/dhashmap.c \
	src/expansible-buffer.c \
	src/istream-forward.c src/istream-catch.c \
	src/stopwatch.c \
	$(POOL_SRC)
test_t_processor_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_run_ajp_client_SOURCES = test/run-ajp-client.c \
	src/ajp-client.c src/ajp-serialize.c \
	src/ajp-headers.c src/ajp-protocol.c \
	src/serialize.c \
	src/uri-verify.c \
	src/buffered-io.c src/fifo-buffer.c \
	src/growing-buffer.c src/fd-util.c src/fd_util.c \
	src/strmap.c src/hashmap.c \
	src/strutil.c \
	src/istream-gb.c \
	src/istream-file.c \
	src/istream-cat.c \
	src/istream-memory.c \
	src/istream-forward.c \
	src/istream-ajp-body.c \
	src/event2.c \
	src/direct.c \
	$(POOL_SRC)
test_run_ajp_client_LDADD = $(LIBCM4ALL_DAEMON_LIBS) $(LIBEVENT_LIBS) \
	$(GLIB_LIBS) \
	$(LIBCM4ALL_HTTP_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_run_memcached_client_SOURCES = test/run-memcached-client.c \
	src/memcached-client.c src/memcached-packet.c \
	src/buffered-io.c src/fifo-buffer.c \
	src/socket-util.c src/fd-util.c \
	src/istream-cat.c src/istream-memory.c src/istream-null.c \
	src/istream-string.c \
	src/event2.c \
	$(POOL_SRC)
test_run_memcached_client_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_dump_memcached_choice_SOURCES = test/dump-memcached-choice.c \
	src/memcached-client.c src/memcached-packet.c \
	src/buffered-io.c src/fifo-buffer.c \
	src/socket-util.c src/fd-util.c \
	src/istream-cat.c src/istream-memory.c src/istream-null.c \
	src/istream-string.c \
	src/event2.c \
	src/serialize.c \
	src/growing-buffer.c src/sink-buffer.c \
	src/strmap.c src/hashmap.c \
	src/tpool.c \
	$(POOL_SRC)
test_dump_memcached_choice_LDADD = $(LIBEVENT_LIBS) $(GLIB_LIBS) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_cleanup_memcached_choice_SOURCES = test/cleanup-memcached-choice.c \
	src/uri-address.c src/uri-resolver.c src/uri-edit.c \
	src/address-list.c \
	src/failure.c src/bulldog.c src/balancer.c \
	src/tcp-stock.c src/tcp-balancer.c \
	src/cache.c \
	src/client-socket.c src/fd_util.c \
	src/stock.c src/hstock.c \
	src/memcached-client.c src/memcached-packet.c \
	src/memcached-stock.c \
	src/http-cache-choice.c src/http-cache-rfc.c \
	src/date.c src/http-util.c src/format.c src/gmtime.c src/strutil.c \
	src/serialize.c \
	src/istream-null.c src/istream-memory.c src/istream-cat.c \
	src/sink-buffer.c \
	src/growing-buffer.c \
	src/buffered-io.c src/fifo-buffer.c \
	src/hashmap.c src/strmap.c \
	src/event2.c \
	src/tpool.c \
	src/stopwatch.c \
	$(POOL_SRC)
test_cleanup_memcached_choice_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) \
	$(LIBCM4ALL_SOCKET_LIBS)

test_fake_memcached_server_SOURCES = test/fake-memcached-server.c

test_t_memcached_client_SOURCES = test/t-memcached-client.c \
	src/memcached-client.c src/memcached-packet.c \
	src/direct.c \
	src/fifo-buffer.c src/buffered-io.c \
	src/socket-util.c src/fd-util.c src/fd_util.c \
	src/event2.c \
	src/istream-memory.c src/istream-null.c src/istream-cat.c \
	$(POOL_SRC)
test_t_memcached_client_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_run_delegate_SOURCES = test/run-delegate.c \
	src/delegate-stock.c src/delegate-client.c src/delegate-glue.c \
	src/hashmap.c src/hstock.c src/stock.c \
	src/defer.c \
	src/jail.c \
	src/fd_util.c \
	$(POOL_SRC)
test_run_delegate_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

test_dump_udp_SOURCES = test/dump-udp.c \
	src/udp-listener.c \
	src/fd_util.c \
	$(POOL_SRC)
test_dump_udp_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) $(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBEVENT_LIBS)

test_dump_control_SOURCES = test/dump-control.c \
	src/udp-listener.c \
	src/fd_util.c \
	src/control-server.c \
	$(POOL_SRC)
test_dump_control_LDADD = $(AM_LDADD) \
	$(LIBCM4ALL_DAEMON_LIBS) $(LIBCM4ALL_SOCKET_LIBS) \
	$(LIBEVENT_LIBS)

test_send_control_SOURCES = test/send-control.c
test_send_control_LDADD = $(LIBCM4ALL_SOCKET_LIBS)

test_run_parser_cdata_SOURCES = test/t-parser-cdata.c \
	src/parser.c src/istream-file.c \
	src/fifo-buffer.c src/buffered-io.c src/expansible-buffer.c \
	src/fd_util.c \
	$(POOL_SRC)
test_run_parser_cdata_LDADD = $(AM_LDADD) $(LIBCM4ALL_DAEMON_LIBS)

endif

#
# Sparse
#

SPARSE_FLAGS = -DSPARSE \
	-Wdecl -Wdefault-bitfield-sign -Wdo-while -Wenum-mismatch \
	-Wnon-pointer-null -Wptr-subtraction-blows -Wreturn-void \
	-Wshadow -Wtypesign

SPARSE_FLAGS += $(INCLUDES) $(AM_CPPFLAGS) -DVERSION=0
SPARSE_FLAGS += -D__SCHAR_MAX__=127 -D__SHRT_MAX__=32767 \
	-D__INT_MAX__=2147483647 -D__LONG_MAX__=2147483647

sparse-check:
	sparse $(SPARSE_FLAGS) $(src_cm4all_beng_proxy_SOURCES)

.PHONY: sparse-check


#
# JavaScript
#

jsdir = $(pkgdatadir)/js
js_DATA = js/beng-proxy.js


#
# Python
#

pythondir = $(pkgdatadir)/python/beng_proxy
python_DATA = python/beng_proxy/__init__.py

pythontdir = $(pkgdatadir)/python/beng_proxy/translation
pythont_DATA = \
	python/beng_proxy/translation/protocol.py \
	python/beng_proxy/translation/request.py \
	python/beng_proxy/translation/response.py \
	python/beng_proxy/translation/serialize.py \
	python/beng_proxy/translation/uri.py \
	python/beng_proxy/translation/__init__.py


#
# Running beng-proxy
#

DEBUG_ARGS = -vvvvvD

debug: src/cm4all-beng-proxy
	LD_LIBRARY_PATH=/usr/lib/debug:$(LD_LIBRARY_PATH) gdb -x gdbrun --args $< $(DEBUG_ARGS)

VALGRIND_FLAGS = --leak-check=yes --show-reachable=yes
VALGRIND_FLAGS += --track-fds=yes --track-origins=yes

valgrind: AM_CPPFLAGS += -DPOOL_LIBC_ONLY
valgrind: export G_SLICE=always-malloc
valgrind: src/cm4all-beng-proxy
	valgrind $(VALGRIND_FLAGS) ./src/cm4all-beng-proxy $(DEBUG_ARGS)

perf: src/cm4all-beng-proxy
	perf record -f $< -D -u max -p 8080

# -DNO_DATE_HEADER -DNO_XATTR -DNO_LAST_MODIFIED_HEADER
benchmark: AM_CPPFLAGS += -DNDEBUG -DALWAYS_INLINE -DNO_ACCESS_LOG -DNO_XATTR
benchmark: src/cm4all-beng-proxy
	./src/cm4all-beng-proxy -D -u max -p 8080 -w 4

.PHONY: debug valgrind perf benchmark

#profile: CFLAGS = -O3 -DNDEBUG -DSPLICE -DPROFILE -DNO_ACCESS_LOG -g -pg
#profile: LDFLAGS = -lc_p -pg
#profile: src/cm4all-beng-proxy
#	./src/cm4all-beng-proxy -D -u max -p 8080

#
# Documentation
#

if DOCUMENTATION
doc/beng.pdf: $(srcdir)/doc/beng.tex
	@mkdir -p $(@D)
	pdflatex -output-directory $(@D) $<
	pdflatex -output-directory $(@D) $<

doc/beng.dvi: doc/beng.tex
	@mkdir -p $(@D)
	latex -output-directory $(@D) $<
	latex -output-directory $(@D) $<
endif

#
# Demo
#

COMAC = /usr/bin/cm4all-comac --quiet-output

.PHONY: upload
upload:
	scp demo/cgi-bin/*.py demo/cgi-bin/*.sh demo/base.html demo/nested_base.html demo/container.html cfatest01:/var/www/vol1/HTO01F/LY/YL/XT/pr_0001/widgets/

COMA_SRC = $(wildcard $(srcdir)/demo/coma/*.cma)
COMA_CLASSES = $(patsubst $(srcdir)/demo/coma/%.cma,demo/coma/%.cls,$(COMA_SRC))

demo-all: $(COMA_CLASSES)

demo-clean:
	rm -f $(COMA_CLASSES)

$(COMA_CLASSES): demo/coma/%.cls: $(srcdir)/demo/coma/%.cma
	@mkdir -p $(@D)
	$(COMAC) -d $(@D) $<
